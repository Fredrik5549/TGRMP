<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workbalance ‚Äì TRATON (team members + import)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f5f7 url("PMO_mission.png") center/cover fixed no-repeat;
      margin: 0;
      padding: 20px;
      color: #12213b;
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.25);
      padding: 20px 24px 24px 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .logo-wrapper img {
      height: 40px;
      width: auto;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.5px;
    }

    .traton-label {
      margin-top: 2px;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
    }

    .intro-block {
      margin: 8px 0 10px 0;
      max-width: 900px;
      font-size: 14px;
    }

    .intro-text {
      margin-bottom: 4px;
    }

    .helper-link {
      font-size: 13px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    /* CIRCLE + AREA CARDS */

    .circle-layout {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 24px;
    }

    .circle-layout-inner {
      position: relative;
      max-width: 820px;
      width: 100%;
      min-height: 500px;
      margin: 0 auto;
    }

    .circle-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: inline-block;
    }

    .circle-wrapper img {
      max-width: 560px;
      width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.16);
      display: block;
    }

    .area-overlay-box {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 4px 6px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      min-width: 80px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
    }

    .overlay-icons span {
      margin: 0 1px;
    }

    #overlay-Manageability { top: 13%; left: 12%; }
    #overlay-Comprehensibility { top: 13%; right: 12%; }
    #overlay-Meaningfulness { bottom: 11%; left: 12%; }
    #overlay-Recovery { bottom: 11%; right: 12%; }

    .area-card {
      position: absolute;
      width: 190px;
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 12px;
    }

    .area-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .area-title {
      font-weight: bold;
      font-size: 13px;
    }

    .info-link {
      font-size: 11px;
      text-decoration: underline;
      color: #1a73e8;
      cursor: pointer;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .color-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      color: #fff;
      min-width: 58px;
    }

    .blue  { background: #2b6cb0; }
    .green { background: #38a169; }
    .yellow{ background: #ecc94b; color: #000; }
    .red   { background: #e53e3e; }

    .counts {
      font-size: 11px;
    }

    .counts span {
      margin-right: 4px;
    }

    #card-Manageability { top: 6px; left: 0; }
    #card-Comprehensibility { top: 6px; right: 0; }
    #card-Meaningfulness { bottom: 6px; left: 0; }
    #card-Recovery { bottom: 6px; right: 0; }

    /* Inspiration */

    .inspiration {
      margin-top: 10px;
      padding: 16px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .inspiration-title {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .main-emojis {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
    }

    .emoji-btn-main {
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 6px 12px;
      cursor: pointer;
      background: #f9f9f9;
      font-size: 40px;
    }

    .colour-help-link {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
    }

    .colour-help-link span {
      text-decoration: underline;
      color: #1a73e8;
      cursor: pointer;
    }

    .emoji-toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: rgba(18,33,59,0.9);
      color: #fff;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 16px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 2000;
    }

    /* Team member view */

    .members-toggle {
      margin-top: 20px;
      font-size: 14px;
    }

    .members-section {
      margin-top: 10px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }

    .members-section h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .members-section p {
      font-size: 13px;
      margin-top: 0;
    }

    .mini-circle {
      text-align: center;
      margin: 8px 0 12px 0;
    }

    .mini-circle img {
      max-width: 260px;
      width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .member-controls {
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-controls input {
      padding: 6px 8px;
      font-size: 13px;
    }

    .member-controls button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    .member-file-controls {
      margin: 6px 0 10px 0;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-file-controls button {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1a73e8;
      color: #ffffff;
    }

    .member-file-hint {
      font-size: 12px;
      color: #555;
    }

    .member-help-link {
      font-size: 12px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    table.members-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }

    table.members-table th,
    table.members-table td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    table.members-table th {
      background: #12213b;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .emoji-buttons {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1px 4px;
      cursor: pointer;
      background: #f9f9f9;
    }

    .emoji-input {
      width: 70px;
      padding: 2px 4px;
      font-size: 12px;
      margin-left: 2px;
    }

    /* Bottom meta (only week) */

    .bottom-meta {
      margin-top: 20px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .week-field label {
      font-size: 13px;
      display: block;
      margin-bottom: 2px;
    }

    .week-field input {
      padding: 6px 8px;
      font-size: 13px;
      min-width: 140px;
    }

    .export-container button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #ffffff;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal section {
      margin-bottom: 10px;
    }

    .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }

    @media (max-width: 800px) {
      body { padding: 8px; }
      .page-shell { padding: 14px; }
      header { flex-direction: column; align-items: flex-start; }
      .logo-wrapper img { height: 32px; }
      .circle-layout-inner { min-height: auto; }
      .area-card { position: static; width: 100%; margin-top: 8px; }
      .circle-wrapper {
        position: static;
        transform: none;
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .area-overlay-box { display: none; }
      .bottom-meta { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-wrapper">
        <img src="Traton_logo.png" alt="TRATON Group logo">
      </div>
      <div class="header-text">
        <h1>Workbalance</h1>
        <div class="traton-label">TRATON GROUP ‚Äì WORK BALANCE DIALOGUE</div>
      </div>
    </header>

    <div class="intro-block">
      <div class="intro-text">
        Workbalance is a support for dialogue in the team about how sustainable the work situation is.
        You rate four areas together ‚Äì Manageability, Comprehensibility, Meaningfulness and Recovery ‚Äì
        using the colours blue, green, yellow and red. The model is based on structured reflection and
        shared responsibility: everyone contributes with experiences, the team identifies patterns, and
        you agree on concrete actions to strengthen a healthy balance over time.
      </div>
      <span class="helper-link" onclick="openUsageInfo()" title="Short guide to how this page works">
        How do we use this page?
      </span>
    </div>

    <!-- CIRCLE + AREA CARDS -->
    <div class="circle-layout">
      <div class="circle-layout-inner">
        <div class="circle-wrapper">
          <img src="workbalance_circle.png" alt="Work Balance Model">
          <div class="area-overlay-box" id="overlay-Manageability"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Comprehensibility"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Meaningfulness"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Recovery"><div class="overlay-icons"></div></div>
        </div>

        <div class="area-card" id="card-Manageability">
          <div class="area-title-row">
            <div class="area-title">Manageability</div>
            <span class="info-link" onclick="openAreaInfo('Manageability')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Manageability','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Manageability','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Manageability','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Manageability','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Manageability"></div>
        </div>

        <div class="area-card" id="card-Comprehensibility">
          <div class="area-title-row">
            <div class="area-title">Comprehensibility</div>
            <span class="info-link" onclick="openAreaInfo('Comprehensibility')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Comprehensibility','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Comprehensibility','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Comprehensibility','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Comprehensibility','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Comprehensibility"></div>
        </div>

        <div class="area-card" id="card-Meaningfulness">
          <div class="area-title-row">
            <div class="area-title">Meaningfulness</div>
            <span class="info-link" onclick="openAreaInfo('Meaningfulness')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Meaningfulness','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Meaningfulness','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Meaningfulness','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Meaningfulness','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Meaningfulness"></div>
        </div>

        <div class="area-card" id="card-Recovery">
          <div class="area-title-row">
            <div class="area-title">Recovery</div>
            <span class="info-link" onclick="openAreaInfo('Recovery')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Recovery','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Recovery','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Recovery','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Recovery','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Recovery"></div>
        </div>
      </div>
    </div>

    <!-- INSPIRATIONAL EMOJIS -->
    <div class="inspiration">
      <div class="inspiration-title">Send some inspiration to your team</div>
      <div class="main-emojis">
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('üëç')">üëç</button>
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('üòä')">üòä</button>
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('üí™')">üí™</button>
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('üôè')">üôè</button>
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('üåü')">üåü</button>
        <button type="button" class="emoji-btn-main" onclick="showMainEmojiToast('‚ù§Ô∏è')">‚ù§Ô∏è</button>
      </div>
      <div class="colour-help-link">
        <span onclick="openStatusInfo()">What should we do with blue/green and yellow/red?</span>
      </div>
    </div>

    <!-- TEAM MEMBER VIEW -->
    <div class="members-toggle">
      <label>
        <input type="checkbox" id="toggleMembers" onchange="toggleMembersSection()">
        Add status per team member (optional ‚Äì see individual status and add support emojis)
      </label>
    </div>

    <div class="members-section" id="membersSection">
      <h2>Team member view (optional)</h2>
      <p>
        Here you can add team members and assign a colour per area.
        You can reuse names and previous inputs by importing an Excel file that was exported from this page.
      </p>

      <div class="mini-circle">
        <img src="workbalance_circle.png" alt="Work Balance Model (mini)">
      </div>

      <div class="member-controls">
        <input type="text" id="memberNameInput" placeholder="Team member name" />
        <button type="button" onclick="addMember()">Add member</button>
      </div>

      <div class="member-file-controls">
        <button type="button" onclick="document.getElementById('memberFileInput').click()">
          Import from Excel (this tool)
        </button>
        <span class="member-file-hint">
          Use a file exported via ‚ÄúExport to Excel‚Äù to bring back names, colours and emojis from a previous week.
        </span>
        <span class="member-help-link" onclick="openMemberFileInfo()">
          How does import / export work?
        </span>
        <input type="file" id="memberFileInput" accept=".xls,.xlsx,.html,.htm" style="display:none"
               onchange="handleMemberFileImport(this.files[0])">
      </div>

      <div style="max-height: 260px; overflow-y: auto;">
        <table class="members-table" id="membersTable">
          <thead>
            <tr>
              <th>Member</th>
              <th>Manageability</th>
              <th>Comprehensibility</th>
              <th>Meaningfulness</th>
              <th>Recovery</th>
              <th>Support emojis</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- WEEK + EXPORT -->
    <div class="bottom-meta">
      <div class="week-field">
        <label for="weekInput">Week</label>
        <input id="weekInput" type="text" placeholder="e.g. 2025‚Äì12 or W15" />
      </div>
      <div class="export-container">
        <button onclick="exportToExcel()">Export to Excel</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modal">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- EMOJI TOAST -->
  <div class="emoji-toast" id="emojiToast">
    <span id="emojiToastIcon"></span>
    <span>Thanks for supporting your team!</span>
  </div>

  <script>
    const areas = [
      "Manageability",
      "Comprehensibility",
      "Meaningfulness",
      "Recovery"
    ];

    const areaInfo = {
      "Manageability": {
        definition:
          "Manageability is about your overall conditions at work ‚Äì the balance between demands and resources, support, clarity and the possibility to influence.",
        questions: [
          "Do you have sufficient time and resources to complete your duties?",
          "Are the right demands being made of you?",
          "Are you able to influence your work situation?",
          "Can you raise and escalate issues ‚Äì and do you get support when you do?",
          "Do you know what is expected of you and are there working methods that make things easier?"
        ]
      },
      "Comprehensibility": {
        definition:
          "Comprehensibility is the feeling of understanding the organisation‚Äôs goals and how your work contributes. It requires openness and a clear overall picture.",
        questions: [
          "Do you understand what is going on in the organisation?",
          "Do you feel coherence with the organisational goals?",
          "If you have different roles, do they fit together?",
          "Do you feel safe and treated with respect at work?",
          "Do you receive continuous feedback that helps you progress?"
        ]
      },
      "Meaningfulness": {
        definition:
          "Meaningfulness is about being appreciated and included in a fair and stimulating social climate. A high sense of meaningfulness generates motivation and creativity.",
        questions: [
          "Do you feel fairly treated in relation to your colleagues?",
          "Do you feel included in what is going on and encouraged to participate?",
          "Do you receive sufficient acknowledgement and do you celebrate success?",
          "Do you find your work tasks motivating?",
          "Do you follow your personal development plan?"
        ]
      },
      "Recovery": {
        definition:
          "Recovery is about variation in work, the ability to use breaks for movement or rest, and having time for focus and reflection so that energy can be restored.",
        questions: [
          "Can you put work thoughts aside outside working hours?",
          "Can you use breaks at work to relax and recover?",
          "Are you able to move around during breaks?",
          "Do you feel energised coming to work and have energy left when you go home?",
          "Do you have time for reflection and conditions for focused work?"
        ]
      }
    };

    const statusAdvice = {
      title: "How to work with the colours",
      html: `
        <section>
          <strong>Blue‚ÄìGreen: Maintain what works</strong><br/>
          Focus: keep and strengthen helpful conditions.<br/>
          ‚Ä¢ Identify which behaviours, routines or conditions make the area blue/green.<br/>
          ‚Ä¢ Make them visible in the team ‚Äì ‚Äúwhat do we want to protect and continue doing?‚Äù.<br/>
          ‚Ä¢ Use them as examples when you work with yellow/red areas.<br/>
          ‚Ä¢ Write down concrete habits and ways of working that you want to keep.
        </section>
        <section>
          <strong>Yellow‚ÄìRed: Act and improve</strong><br/>
          Focus: early signals, dialogue and concrete improvements.<br/>
          ‚Ä¢ Use the reflection questions for the area to understand why the status is yellow or red.<br/>
          ‚Ä¢ Decide on 1‚Äì3 small, realistic improvements to test before the next check-in.<br/>
          ‚Ä¢ Clarify who does what and by when ‚Äì and follow up at the next Workbalance dialogue.<br/>
          ‚Ä¢ Long-lasting red status should always lead to action or escalation (manager/HR/work environment support).
        </section>
      `
    };

    const usageInfo = {
      title: "How to use this page",
      html: `
        <section>
          <strong>1. Start with a joint check-in</strong><br/>
          Briefly introduce the four areas and agree on which week and situation the dialogue refers to.
        </section>
        <section>
          <strong>2. Rate each area together</strong><br/>
          For every area, click the colour buttons (blue, green, yellow, red) to represent the voices in the team.
          The icons on the Workbalance circle show how many of each status you have in every quadrant.
        </section>
        <section>
          <strong>3. Explore what is behind the colours</strong><br/>
          Use ‚ÄúWhat does this mean?‚Äù to open the reflection questions. Talk about why an area is blue/green
          (what you want to keep) or yellow/red (what needs to change).
        </section>
        <section>
          <strong>4. Use the team member view when needed</strong><br/>
          If you want to go deeper, activate the team member view to see status per person and add support emojis.
          You can reuse previous sessions by importing an Excel file that was exported from this page.
        </section>
        <section>
          <strong>5. Export for follow-up</strong><br/>
          When you are done, type the week and use ‚ÄúExport to Excel‚Äù to save the result.
          Next time you meet, you can import the same file to continue working from where you left off.
        </section>
      `
    };

    const memberFileInfo = {
      title: "Import / export for team members",
      html: `
        <section>
          <strong>Export</strong><br/>
          ‚ÄúExport to Excel‚Äù creates an .xls file with your current week, the colour summary per area
          and ‚Äì if you use the team member view ‚Äì a table with all members, their colours and support emojis.
        </section>
        <section>
          <strong>Import</strong><br/>
          To reuse names and colours, go to the team member view and click
          ‚ÄúImport from Excel (this tool)‚Äù. Choose a file that was exported from this Workbalance page.
          The tool reads the member table in the file and repopulates the list of members, their colours and emojis.
        </section>
        <section>
          <strong>Updating the circle</strong><br/>
          When you change colours in the team member table ‚Äì or after importing a file ‚Äì the top Workbalance circle
          is recalculated from the team member data. This gives you one consistent overview for the current week.
        </section>
      `
    };

    const areaData = {};
    const overall = { blue: 0, green: 0, yellow: 0, red: 0 };

    const members = [];
    const supportEmojis = ["üëç","üòä","üí™","üôè","üåü","‚ù§Ô∏è"];
    let toastTimeout = null;

    function initAreas() {
      areas.forEach(area => {
        areaData[area] = areaData[area] || { blue: 0, green: 0, yellow: 0, red: 0 };
        updateAreaCounts(area);
      });
      updateOverlayAreas();
    }

    function increment(area, color) {
      areaData[area][color]++;
      overall[color]++;
      updateAreaCounts(area);
      updateOverlayAreas();
    }

    function updateAreaCounts(area) {
      const el = document.getElementById("counts-" + area.replace(/\s/g, ""));
      if (!el) return;
      const d = areaData[area];
      el.innerHTML = `
        <span><strong>B:</strong> ${d.blue}</span>
        <span><strong>G:</strong> ${d.green}</span>
        <span><strong>Y:</strong> ${d.yellow}</span>
        <span><strong>R:</strong> ${d.red}</span>
      `;
    }

    function makeStatusIcons(d) {
      const icons = [];
      if (d.blue > 0)  icons.push("üîµ".repeat(Math.min(d.blue, 10)) + (d.blue > 10 ? "+" : ""));
      if (d.green > 0) icons.push("üü¢".repeat(Math.min(d.green, 10)) + (d.green > 10 ? "+" : ""));
      if (d.yellow > 0)icons.push("üü°".repeat(Math.min(d.yellow, 10)) + (d.yellow > 10 ? "+" : ""));
      if (d.red > 0)   icons.push("üî¥".repeat(Math.min(d.red, 10)) + (d.red > 10 ? "+" : ""));
      if (icons.length === 0) return '<span style="font-size:11px;color:#666;">‚Äì</span>';
      return icons.map(row => `<span>${row}</span>`).join("");
    }

    function updateOverlayAreas() {
      areas.forEach(area => {
        const overlay = document.getElementById("overlay-" + area);
        if (!overlay) return;
        const iconsDiv = overlay.querySelector(".overlay-icons");
        const d = areaData[area] || { blue: 0, green: 0, yellow: 0, red: 0 };
        iconsDiv.innerHTML = makeStatusIcons(d);
      });
    }

    function openModal(html) {
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modalBackdrop").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modalBackdrop").style.display = "none";
    }

    function openAreaInfo(area) {
      const info = areaInfo[area];
      const html = `
        <h3>${area}</h3>
        <section><strong>Definition:</strong><br/>${info.definition}</section>
        <section><strong>Reflection questions:</strong>
          <ul>${info.questions.map(q => `<li>${q}</li>`).join("")}</ul>
        </section>
        <section>
          <strong>Colour hints:</strong><br/>
          ‚Ä¢ Blue/Green ‚Äì keep and spread what works.<br/>
          ‚Ä¢ Yellow ‚Äì follow up and agree on improvements.<br/>
          ‚Ä¢ Red ‚Äì urgent: understand causes, act and consider escalation.
        </section>`;
      openModal(html);
    }
    function openStatusInfo() {
      openModal(`<h3>${statusAdvice.title}</h3>${statusAdvice.html}`);
    }
    function openUsageInfo() {
      openModal(`<h3>${usageInfo.title}</h3>${usageInfo.html}`);
    }
    function openMemberFileInfo() {
      openModal(`<h3>${memberFileInfo.title}</h3>${memberFileInfo.html}`);
    }

    function toggleMembersSection() {
      const checked = document.getElementById("toggleMembers").checked;
      document.getElementById("membersSection").style.display = checked ? "block" : "none";
    }

    function addMember() {
      const nameInput = document.getElementById("memberNameInput");
      const name = nameInput.value.trim();
      if (!name) return;
      members.push({ name, ratings: {}, emojis: "" });
      nameInput.value = "";
      renderMembersTable();
      recalcFromMembers();
    }

    function renderMembersTable() {
      const tbody = document.getElementById("membersTable").querySelector("tbody");
      tbody.innerHTML = "";
      members.forEach(member => {
        const row = document.createElement("tr");
        const nameTd = document.createElement("td");
        nameTd.textContent = member.name;
        row.appendChild(nameTd);

        areas.forEach(area => {
          const td = document.createElement("td");
          const select = document.createElement("select");
          select.style.fontSize = "11px";
          ["", "blue", "green", "yellow", "red"].forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val === "" ? "-" : val.charAt(0).toUpperCase() + val.slice(1);
            if ((member.ratings[area] || "") === val) opt.selected = true;
            select.appendChild(opt);
          });
          select.addEventListener("change", () => {
            member.ratings[area] = select.value;
            recalcFromMembers();
          });
          td.appendChild(select);
          row.appendChild(td);
        });

        const emojisTd = document.createElement("td");
        const emojiBtns = document.createElement("div");
        emojiBtns.className = "emoji-buttons";
        const emojiInput = document.createElement("input");
        emojiInput.className = "emoji-input";
        emojiInput.type = "text";
        emojiInput.placeholder = "üëçüí™‚ù§Ô∏è";
        emojiInput.value = member.emojis || "";
        emojiInput.addEventListener("input", () => {
          member.emojis = emojiInput.value;
        });

        supportEmojis.forEach(e => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "emoji-btn";
          b.textContent = e;
          b.addEventListener("click", () => {
            emojiInput.value += e;
            member.emojis = emojiInput.value;
          });
          emojiBtns.appendChild(b);
        });

        emojisTd.appendChild(emojiBtns);
        emojisTd.appendChild(emojiInput);
        row.appendChild(emojisTd);
        tbody.appendChild(row);
      });
    }

    function recalcFromMembers() {
      areas.forEach(area => { areaData[area] = { blue: 0, green: 0, yellow: 0, red: 0 }; });
      overall.blue = overall.green = overall.yellow = overall.red = 0;

      members.forEach(m => {
        areas.forEach(area => {
          const c = (m.ratings[area] || "").toLowerCase();
          if (c && areaData[area][c] !== undefined) {
            areaData[area][c]++;
            overall[c]++;
          }
        });
      });

      areas.forEach(updateAreaCounts);
      updateOverlayAreas();
    }

    function handleMemberFileImport(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/html");

        const tables = Array.from(doc.getElementsByTagName("table"));
        if (tables.length > 0) {
          const metaTable = tables[0];
          const rows = metaTable.querySelectorAll("tr");
          if (rows.length >= 2) {
            const weekCell = rows[1].querySelectorAll("td")[1];
            if (weekCell) document.getElementById("weekInput").value = weekCell.textContent.trim();
          }
        }

        let memberTable = null;
        for (const t of tables) {
          const firstTh = t.querySelector("tr th");
          if (!firstTh) continue;
          if (firstTh.textContent.trim().toLowerCase() === "member") {
            memberTable = t;
            break;
          }
        }
        if (!memberTable) {
          alert("Could not find team member data in this file. Make sure it was exported from this Workbalance page.");
          return;
        }

        members.length = 0;
        const rows = memberTable.querySelectorAll("tr");
        for (let i = 1; i < rows.length; i++) {
          const cells = rows[i].querySelectorAll("td");
          if (cells.length < 6) continue;
          const name = cells[0].textContent.trim();
          if (!name) continue;
          members.push({
            name,
            ratings: {
              "Manageability": cells[1].textContent.trim().toLowerCase(),
              "Comprehensibility": cells[2].textContent.trim().toLowerCase(),
              "Meaningfulness": cells[3].textContent.trim().toLowerCase(),
              "Recovery": cells[4].textContent.trim().toLowerCase()
            },
            emojis: cells[5].textContent.trim()
          });
        }
        renderMembersTable();
        recalcFromMembers();
        alert("Team members imported from file.");
      };
      reader.readAsText(file);
    }

    function showMainEmojiToast(emoji) {
      const toast = document.getElementById("emojiToast");
      const icon = document.getElementById("emojiToastIcon");
      icon.textContent = emoji;
      toast.style.display = "flex";
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => { toast.style.display = "none"; }, 2500);
    }

    function exportToExcel() {
      const week = document.getElementById("weekInput").value || "";

      let html = `
        <table border="1">
          <tr><th colspan="2">Workbalance ‚Äì TRATON</th></tr>
          <tr><td>Week</td><td>${escapeHtml(week)}</td></tr>
        </table>
        <br/>
        <table border="1">
          <tr>
            <th>Area</th>
            <th>Blue (excellent)</th>
            <th>Green (good)</th>
            <th>Yellow (insufficient)</th>
            <th>Red (poor)</th>
          </tr>`;

      areas.forEach(area => {
        const d = areaData[area];
        html += `
          <tr>
            <td>${escapeHtml(area)}</td>
            <td>${d.blue}</td>
            <td>${d.green}</td>
            <td>${d.yellow}</td>
            <td>${d.red}</td>
          </tr>`;
      });

      html += `
          <tr>
            <th>Total</th>
            <th>${overall.blue}</th>
            <th>${overall.green}</th>
            <th>${overall.yellow}</th>
            <th>${overall.red}</th>
          </tr>
        </table>`;

      if (members.length > 0) {
        html += `
          <br/>
          <table border="1">
            <tr>
              <th>Member</th>
              <th>Manageability</th>
              <th>Comprehensibility</th>
              <th>Meaningfulness</th>
              <th>Recovery</th>
              <th>Support emojis</th>
            </tr>`;
        members.forEach(m => {
          html += `
            <tr>
              <td>${escapeHtml(m.name)}</td>
              <td>${escapeHtml(m.ratings["Manageability"] || "")}</td>
              <td>${escapeHtml(m.ratings["Comprehensibility"] || "")}</td>
              <td>${escapeHtml(m.ratings["Meaningfulness"] || "")}</td>
              <td>${escapeHtml(m.ratings["Recovery"] || "")}</td>
              <td>${escapeHtml(m.emojis || "")}</td>
            </tr>`;
        });
        html += `</table>`;
      }

      const blob = new Blob(
        ['\ufeff<html><head><meta charset="UTF-8"></head><body>' + html + '</body></html>'],
        { type: 'application/vnd.ms-excel' }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const fileWeek = week ? "_" + week.replace(/\s+/g,"_") : "";
      a.href = url;
      a.download = "Workbalance" + fileWeek + ".xls";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    window.addEventListener("DOMContentLoaded", initAreas);
  </script>
</body>
</html>
