<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workbalance ‚Äì TRATON (history + import/export)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f5f7 url("PMO_mission.png") center/cover fixed no-repeat;
      margin: 0;
      padding: 20px;
      color: #12213b;
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.25);
      padding: 20px 24px 24px 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .logo-wrapper img {
      height: 40px;
      width: auto;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.5px;
    }

    .traton-label {
      margin-top: 2px;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
    }

    .intro-block {
      margin: 8px 0 10px 0;
      max-width: 900px;
      font-size: 14px;
    }

    .intro-text {
      margin-bottom: 4px;
    }

    .helper-link {
      font-size: 13px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    /* CIRCLE + AREA CARDS */

    .circle-layout {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 24px;
    }

    .circle-layout-inner {
      position: relative;
      max-width: 820px;
      width: 100%;
      min-height: 500px;
      margin: 0 auto;
    }

    .circle-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: inline-block;
    }

    .circle-wrapper img {
      max-width: 560px;
      width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.16);
      display: block;
    }

    .area-overlay-box {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 4px 6px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      min-width: 80px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
    }

    .overlay-icons span {
      margin: 0 1px;
    }

    #overlay-Manageability { top: 13%; left: 12%; }
    #overlay-Comprehensibility { top: 13%; right: 12%; }
    #overlay-Meaningfulness { bottom: 11%; left: 12%; }
    #overlay-Recovery { bottom: 11%; right: 12%; }

    .area-card {
      position: absolute;
      width: 190px;
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 12px;
    }

    .area-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .area-title {
      font-weight: bold;
      font-size: 13px;
    }

    .info-link {
      font-size: 11px;
      text-decoration: underline;
      color: #1a73e8;
      cursor: pointer;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }

    .color-btn {
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      color: #fff;
      min-width: 58px;
    }

    .blue  { background: #2b6cb0; }
    .green { background: #38a169; }
    .yellow{ background: #ecc94b; color: #000; }
    .red   { background: #e53e3e; }

    .counts {
      font-size: 11px;
    }

    .counts span {
      margin-right: 4px;
    }

    #card-Manageability { top: 6px; left: 0; }
    #card-Comprehensibility { top: 6px; right: 0; }
    #card-Meaningfulness { bottom: 6px; left: 0; }
    #card-Recovery { bottom: 6px; right: 0; }

    /* Team member view */

    .members-toggle {
      margin-top: 20px;
      font-size: 14px;
    }

    .members-section {
      margin-top: 10px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }

    .members-section h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .members-section p {
      font-size: 13px;
      margin-top: 0;
    }

    .member-controls {
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-controls input {
      padding: 6px 8px;
      font-size: 13px;
    }

    .member-controls button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    .member-file-controls {
      margin: 6px 0 10px 0;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-file-controls button {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1a73e8;
      color: #ffffff;
    }

    .member-file-hint {
      font-size: 12px;
      color: #555;
    }

    .member-help-link {
      font-size: 12px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    table.members-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }

    table.members-table th,
    table.members-table td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    table.members-table th {
      background: #12213b;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .emoji-buttons {
      display: flex;
      gap: 2px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1px 4px;
      cursor: pointer;
      background: #f9f9f9;
    }

    .emoji-input {
      width: 70px;
      padding: 2px 4px;
      font-size: 12px;
      margin-left: 2px;
    }

    .remove-btn {
      border: none;
      background: #e53e3e;
      color: #fff;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 11px;
    }

    /* Bottom ‚Äì Week + Team + Export */

    .bottom-meta {
      margin-top: 20px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .meta-fields {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .meta-fields label {
      font-size: 13px;
      display: block;
      margin-bottom: 2px;
    }

    .meta-fields input {
      padding: 6px 8px;
      font-size: 13px;
      min-width: 140px;
    }

    .export-container button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #ffffff;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal section {
      margin-bottom: 10px;
    }

    .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }

    @media (max-width: 800px) {
      body { padding: 8px; }
      .page-shell { padding: 14px; }
      header { flex-direction: column; align-items: flex-start; }
      .logo-wrapper img { height: 32px; }
      .circle-layout-inner { min-height: auto; }
      .area-card { position: static; width: 100%; margin-top: 8px; }
      .circle-wrapper {
        position: static;
        transform: none;
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .area-overlay-box { display: none; }
      .bottom-meta { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-wrapper">
        <img src="Traton_logo.png" alt="TRATON Group logo">
      </div>
      <div class="header-text">
        <h1>Workbalance</h1>
        <div class="traton-label">TRATON GROUP ‚Äì WORK BALANCE DIALOGUE</div>
      </div>
    </header>

    <div class="intro-block">
      <div class="intro-text">
        Workbalance is a support for dialogue in the team about how sustainable the work situation is.
        You rate four areas together ‚Äì Manageability, Comprehensibility, Meaningfulness and Recovery ‚Äì
        using the colours blue, green, yellow and red. The model is based on structured reflection and
        shared responsibility: everyone contributes with experiences, the team identifies patterns, and
        you agree on concrete actions to strengthen a healthy balance over time.
      </div>
      <span class="helper-link" onclick="openUsageInfo()">
        How do we use this page?
      </span>
    </div>

    <!-- CIRCLE + AREA CARDS -->
    <div class="circle-layout">
      <div class="circle-layout-inner">
        <div class="circle-wrapper">
          <img src="workbalance_circle.png" alt="Work Balance Model">
          <div class="area-overlay-box" id="overlay-Manageability"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Comprehensibility"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Meaningfulness"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Recovery"><div class="overlay-icons"></div></div>
        </div>

        <div class="area-card" id="card-Manageability">
          <div class="area-title-row">
            <div class="area-title">Manageability</div>
            <span class="info-link" onclick="openAreaInfo('Manageability')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Manageability','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Manageability','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Manageability','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Manageability','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Manageability"></div>
        </div>

        <div class="area-card" id="card-Comprehensibility">
          <div class="area-title-row">
            <div class="area-title">Comprehensibility</div>
            <span class="info-link" onclick="openAreaInfo('Comprehensibility')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Comprehensibility','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Comprehensibility','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Comprehensibility','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Comprehensibility','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Comprehensibility"></div>
        </div>

        <div class="area-card" id="card-Meaningfulness">
          <div class="area-title-row">
            <div class="area-title">Meaningfulness</div>
            <span class="info-link" onclick="openAreaInfo('Meaningfulness')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Meaningfulness','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Meaningfulness','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Meaningfulness','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Meaningfulness','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Meaningfulness"></div>
        </div>

        <div class="area-card" id="card-Recovery">
          <div class="area-title-row">
            <div class="area-title">Recovery</div>
            <span class="info-link" onclick="openAreaInfo('Recovery')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Recovery','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Recovery','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Recovery','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Recovery','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Recovery"></div>
        </div>
      </div>
    </div>

    <!-- TEAM MEMBER VIEW -->
    <div class="members-toggle">
      <label>
        <input type="checkbox" id="toggleMembers" onchange="toggleMembersSection()">
        Add status per team member (optional ‚Äì keeps history week by week)
      </label>
    </div>

    <div class="members-section" id="membersSection">
      <h2>Team member view (optional)</h2>
      <p>
        Here you can add team members and assign a colour per area for the selected week and team.
        When you import a file that was exported from this page you get back all earlier weeks,
        and the upper circle is recalculated from the current week‚Äôs individual statuses.
        <span class="member-help-link" onclick="openMemberFileInfo()">How does import / export work?</span>
      </p>

      <div class="member-controls">
        <input type="text" id="memberNameInput" placeholder="Team member name" />
        <button type="button" onclick="addMember()">Add member</button>
      </div>

      <div class="member-file-controls">
        <button type="button" onclick="document.getElementById('memberFileInput').click()">
          Import from Excel (history file)
        </button>
        <span class="member-file-hint">
          Use an .xlsx file exported from this page to bring back names and history.
        </span>
        <input type="file" id="memberFileInput" accept=".xlsx" style="display:none"
               onchange="handleMemberFileImport(this.files[0])">
      </div>

      <div style="max-height: 280px; overflow-y: auto;">
        <table class="members-table" id="membersTable">
          <thead>
            <tr>
              <th>Member</th>
              <th>Manageability</th>
              <th>Comprehensibility</th>
              <th>Meaningfulness</th>
              <th>Recovery</th>
              <th>Support emojis</th>
              <th>Recent weeks</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- WEEK + TEAM + EXPORT -->
    <div class="bottom-meta">
      <div class="meta-fields">
        <div>
          <label for="teamInput">Team name</label>
          <input id="teamInput" type="text" placeholder="e.g. XTRM Platform" />
        </div>
        <div>
          <label for="weekInput">Week</label>
          <input id="weekInput" type="text" placeholder="e.g. 2025-12 or W15" />
        </div>
      </div>
      <div class="export-container">
        <button onclick="exportToExcel()">Export to Excel</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modal">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- SheetJS for real Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const areas = ["Manageability","Comprehensibility","Meaningfulness","Recovery"];

    const areaInfo = {
      "Manageability": {
        definition:
          "Manageability is about your overall conditions at work ‚Äì the balance between demands and resources, support, clarity and the possibility to influence.",
        questions: [
          "Do you have sufficient time and resources to complete your duties?",
          "Are the right demands being made of you?",
          "Are you able to influence your work situation?",
          "Can you raise and escalate issues ‚Äì and do you get support when you do?",
          "Do you know what is expected of you and are there working methods that make things easier?"
        ]
      },
      "Comprehensibility": {
        definition:
          "Comprehensibility is the feeling of understanding the organisation‚Äôs goals and how your work contributes. It requires openness and a clear overall picture.",
        questions: [
          "Do you understand what is going on in the organisation?",
          "Do you feel coherence with the organisational goals?",
          "If you have different roles, do they fit together?",
          "Do you feel safe and treated with respect at work?",
          "Do you receive continuous feedback that helps you progress?"
        ]
      },
      "Meaningfulness": {
        definition:
          "Meaningfulness is about being appreciated and included in a fair and stimulating social climate. A high sense of meaningfulness generates motivation and creativity.",
        questions: [
          "Do you feel fairly treated in relation to your colleagues?",
          "Do you feel included in what is going on and encouraged to participate?",
          "Do you receive sufficient acknowledgement and do you celebrate success?",
          "Do you find your work tasks motivating?",
          "Do you follow your personal development plan?"
        ]
      },
      "Recovery": {
        definition:
          "Recovery is about variation in work, the ability to use breaks for movement or rest, and having time for focus and reflection so that energy can be restored.",
        questions: [
          "Can you put work thoughts aside outside working hours?",
          "Can you use breaks at work to relax and recover?",
          "Are you able to move around during breaks?",
          "Do you feel energised coming to work and have energy left when you go home?",
          "Do you have time for reflection and conditions for focused work?"
        ]
      }
    };

    const statusAdvice = {
      title: "How to work with the colours",
      html: `
        <section>
          <strong>Blue‚ÄìGreen: Maintain what works</strong><br/>
          Focus: keep and strengthen helpful conditions.<br/>
          ‚Ä¢ Identify which behaviours, routines or conditions make the area blue/green.<br/>
          ‚Ä¢ Make them visible in the team ‚Äì ‚Äúwhat do we want to protect and continue doing?‚Äù.<br/>
          ‚Ä¢ Use them as examples when you work with yellow/red areas.
        </section>
        <section>
          <strong>Yellow‚ÄìRed: Act and improve</strong><br/>
          Focus: early signals, dialogue and concrete improvements.<br/>
          ‚Ä¢ Use the reflection questions for the area to understand why the status is yellow or red.<br/>
          ‚Ä¢ Decide on 1‚Äì3 realistic improvements to test before the next check-in.<br/>
          ‚Ä¢ Clarify who does what and by when ‚Äì and follow up at the next Workbalance dialogue.<br/>
          ‚Ä¢ Long-lasting red status should always lead to action or escalation.
        </section>
      `
    };

    const usageInfo = {
      title: "How to use this page",
      html: `
        <section>
          <strong>1. Decide week and team</strong><br/>
          At the bottom of the page, enter the team name and week that this dialogue refers to.
        </section>
        <section>
          <strong>2. Rate each area together</strong><br/>
          Click the colour buttons for each area to represent the voices in the team.
          The icons on the circle show how many blue, green, yellow and red you have in that area.
        </section>
        <section>
          <strong>3. Optionally use team member view</strong><br/>
          Turn on ‚ÄúAdd status per team member‚Äù to rate per person.
          The upper circle is then calculated from the team member statuses.
        </section>
        <section>
          <strong>4. Import old weeks</strong><br/>
          Import an Excel file exported from this page to get back names and history.
          You can then change the week field and add a new measurement while keeping older weeks.
        </section>
        <section>
          <strong>5. Export and keep building history</strong><br/>
          ‚ÄúExport to Excel‚Äù saves the current week plus all earlier weeks in one file,
          so you can keep reusing the same file as your Workbalance history.
        </section>
      `
    };

    const memberFileInfo = {
      title: "Import / export for team members",
      html: `
        <section>
          <strong>Excel structure</strong><br/>
          The file contains a sheet called <em>‚ÄúMembers‚Äù</em> with one row per member and week:
          <br/><em>Week, Team, Member, Manageability, Comprehensibility, Meaningfulness, Recovery, Emojis</em>.
        </section>
        <section>
          <strong>Import</strong><br/>
          ‚Ä¢ Click ‚ÄúImport from Excel (history file)‚Äù and select an .xlsx that was exported from this page.<br/>
          ‚Ä¢ All historical rows are loaded into memory.<br/>
          ‚Ä¢ Team and week fields are filled from the last rows in the file.<br/>
          ‚Ä¢ For the selected team, the latest status per member is shown in the table,
            and the upper circle is updated accordingly.
        </section>
        <section>
          <strong>New week</strong><br/>
          ‚Ä¢ Change the week field to a new value (for example W16).<br/>
          ‚Ä¢ Adjust colours per member or add/remove members.<br/>
          ‚Ä¢ When you export, new rows are added for this week, while previous weeks are kept.
        </section>
        <section>
          <strong>Export</strong><br/>
          ‚ÄúExport to Excel‚Äù creates a workbook with:<br/>
          ‚Ä¢ Sheet ‚ÄúSummary‚Äù ‚Äì overview for the currently selected week.<br/>
          ‚Ä¢ Sheet ‚ÄúMembers‚Äù ‚Äì all imported rows plus the current week‚Äôs rows (old rows for that week/team are replaced).<br/>
          Use the same file next time to keep building weekly history.
        </section>
      `
    };

    const areaData = {};
    const overall = { blue: 0, green: 0, yellow: 0, red: 0 };

    const members = []; // current week/team view [{name, ratings:{area:color}, emojis}]
    const supportEmojis = ["üëç","üòä","üí™","üôè","üåü","‚ù§Ô∏è"];

    let historyRows = []; // all weeks, all teams
    let toastTimeout = null;

    function initAreas() {
      areas.forEach(a => areaData[a] = { blue:0, green:0, yellow:0, red:0 });
      areas.forEach(updateAreaCounts);
      updateOverlayAreas();
    }

    function openModal(html) {
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modalBackdrop").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modalBackdrop").style.display = "none";
    }

    function openAreaInfo(area) {
      const info = areaInfo[area];
      const html = `
        <h3>${area}</h3>
        <section><strong>Definition:</strong><br/>${info.definition}</section>
        <section><strong>Reflection questions:</strong>
          <ul>${info.questions.map(q => `<li>${q}</li>`).join("")}</ul>
        </section>
        <section>
          <strong>Colour hints:</strong><br/>
          ‚Ä¢ Blue/Green ‚Äì keep and spread what works.<br/>
          ‚Ä¢ Yellow ‚Äì follow up and agree on improvements.<br/>
          ‚Ä¢ Red ‚Äì urgent: understand causes, act and consider escalation.
        </section>`;
      openModal(html);
    }
    function openStatusInfo() {
      openModal(`<h3>${statusAdvice.title}</h3>${statusAdvice.html}`);
    }
    function openUsageInfo() {
      openModal(`<h3>${usageInfo.title}</h3>${usageInfo.html}`);
    }
    function openMemberFileInfo() {
      openModal(`<h3>${memberFileInfo.title}</h3>${memberFileInfo.html}`);
    }

    function increment(area, colour) {
      areaData[area][colour]++;
      overall[colour]++;
      updateAreaCounts(area);
      updateOverlayAreas();
    }

    function updateAreaCounts(area) {
      const el = document.getElementById("counts-" + area.replace(/\s/g,""));
      if (!el) return;
      const d = areaData[area];
      el.innerHTML =
        `<span><strong>B:</strong> ${d.blue}</span>` +
        `<span><strong>G:</strong> ${d.green}</span>` +
        `<span><strong>Y:</strong> ${d.yellow}</span>` +
        `<span><strong>R:</strong> ${d.red}</span>`;
    }

    function makeStatusIcons(d) {
      const icons = [];
      if (d.blue  > 0) icons.push("üîµ".repeat(Math.min(d.blue,10))   + (d.blue  >10?"+":""));
      if (d.green > 0) icons.push("üü¢".repeat(Math.min(d.green,10))  + (d.green >10?"+":""));
      if (d.yellow> 0) icons.push("üü°".repeat(Math.min(d.yellow,10)) + (d.yellow>10?"+":""));
      if (d.red   > 0) icons.push("üî¥".repeat(Math.min(d.red,10))    + (d.red   >10?"+":""));
      if (!icons.length) return '<span style="font-size:11px;color:#666;">‚Äì</span>';
      return icons.map(r => `<span>${r}</span>`).join("");
    }

    function updateOverlayAreas() {
      areas.forEach(area => {
        const overlay = document.getElementById("overlay-" + area);
        if (!overlay) return;
        const iconsDiv = overlay.querySelector(".overlay-icons");
        iconsDiv.innerHTML = makeStatusIcons(areaData[area]);
      });
    }

    function toggleMembersSection() {
      const checked = document.getElementById("toggleMembers").checked;
      document.getElementById("membersSection").style.display = checked ? "block" : "none";
    }

    function addMember() {
      const nameInput = document.getElementById("memberNameInput");
      const name = nameInput.value.trim();
      if (!name) return;
      members.push({ name, ratings:{}, emojis:"" });
      nameInput.value = "";
      renderMembersTable();
      recalcFromMembers();
    }

    function removeMember(index) {
      members.splice(index,1);
      renderMembersTable();
      recalcFromMembers();
    }

    function renderMembersTable() {
      const tbody = document.querySelector("#membersTable tbody");
      tbody.innerHTML = "";
      const team = document.getElementById("teamInput").value.trim();

      members.forEach((member, idx) => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = member.name;
        tr.appendChild(nameTd);

        areas.forEach(area => {
          const td = document.createElement("td");
          const sel = document.createElement("select");
          sel.style.fontSize = "11px";
          ["","blue","green","yellow","red"].forEach(c => {
            const opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c===""?"-":c.charAt(0).toUpperCase()+c.slice(1);
            if ((member.ratings[area] || "") === c) opt.selected = true;
            sel.appendChild(opt);
          });
          sel.addEventListener("change", () => {
            member.ratings[area] = sel.value;
            recalcFromMembers();
          });
          td.appendChild(sel);
          tr.appendChild(td);
        });

        const emojisTd = document.createElement("td");
        const emojiBtns = document.createElement("div");
        emojiBtns.className = "emoji-buttons";
        const emojiInput = document.createElement("input");
        emojiInput.className = "emoji-input";
        emojiInput.type = "text";
        emojiInput.placeholder = "üëçüí™‚ù§Ô∏è";
        emojiInput.value = member.emojis || "";
        emojiInput.addEventListener("input", () => {
          member.emojis = emojiInput.value;
        });
        supportEmojis.forEach(e => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "emoji-btn";
          b.textContent = e;
          b.addEventListener("click", () => {
            emojiInput.value += e;
            member.emojis = emojiInput.value;
          });
          emojiBtns.appendChild(b);
        });
        emojisTd.appendChild(emojiBtns);
        emojisTd.appendChild(emojiInput);
        tr.appendChild(emojisTd);

        // history column
        const histTd = document.createElement("td");
        histTd.style.fontSize = "11px";
        histTd.innerHTML = buildHistorySummary(member.name, team);
        tr.appendChild(histTd);

        const removeTd = document.createElement("td");
        const rmBtn = document.createElement("button");
        rmBtn.className = "remove-btn";
        rmBtn.textContent = "X";
        rmBtn.onclick = () => removeMember(idx);
        removeTd.appendChild(rmBtn);
        tr.appendChild(removeTd);

        tbody.appendChild(tr);
      });
    }

    // Build small history string for a member (last 5 entries)
    function buildHistorySummary(name, team) {
      if (!historyRows.length) return "";
      const rows = historyRows.filter(r => r.Member === name && r.Team === team);
      if (!rows.length) return "";
      // assume rows are in chronological order as they were added
      const last = rows.slice(-5); // last up to 5
      const colourRank = { red:4, yellow:3, green:2, blue:1 };
      const colourEmoji = { blue:"üîµ", green:"üü¢", yellow:"üü°", red:"üî¥" };
      return last.map(r => {
        let best = ""; let bestScore = 0;
        areas.forEach(a => {
          const c = (r[a] || "").toLowerCase();
          if (colourRank[c] && colourRank[c] > bestScore) {
            bestScore = colourRank[c];
            best = c;
          }
        });
        const emoji = colourEmoji[best] || "‚ö™";
        return `${r.Week || "?"}:${emoji}`;
      }).join("<br/>");
    }

    function recalcFromMembers() {
      // reset
      areas.forEach(a => areaData[a] = { blue:0, green:0, yellow:0, red:0 });
      overall.blue = overall.green = overall.yellow = overall.red = 0;

      members.forEach(m => {
        areas.forEach(a => {
          const c = (m.ratings[a] || "").toLowerCase();
          if (c && areaData[a][c] !== undefined) {
            areaData[a][c]++;
            overall[c]++;
          }
        });
      });

      areas.forEach(updateAreaCounts);
      updateOverlayAreas();
    }

    /* ---------- IMPORT REAL XLSX (history) ---------- */

    function handleMemberFileImport(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });

        const sheet = wb.Sheets["Members"] || wb.Sheets[wb.SheetNames[0]];
        if (!sheet) {
          alert("No sheet named 'Members' (or first sheet) found in the file.");
          return;
        }

        historyRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        if (!historyRows.length) {
          alert("The Members sheet is empty.");
          return;
        }

        // derive team + latest week from last row
        const lastRow = historyRows[historyRows.length - 1];
        document.getElementById("teamInput").value = lastRow.Team || "";
        document.getElementById("weekInput").value = lastRow.Week || "";

        // build members list with latest status for this team
        const team = lastRow.Team || "";
        const latest = {};
        historyRows.forEach(r => {
          if (r.Team !== team) return;
          if (!r.Member) return;
          // later rows overwrite earlier ones
          latest[r.Member] = r;
        });

        members.length = 0;
        Object.keys(latest).forEach(name => {
          const r = latest[name];
          members.push({
            name,
            ratings: {
              "Manageability": (r.Manageability || "").toLowerCase(),
              "Comprehensibility": (r.Comprehensibility || "").toLowerCase(),
              "Meaningfulness": (r.Meaningfulness || "").toLowerCase(),
              "Recovery": (r.Recovery || "").toLowerCase()
            },
            emojis: r.Emojis || ""
          });
        });

        document.getElementById("toggleMembers").checked = true;
        document.getElementById("membersSection").style.display = "block";

        renderMembersTable();
        recalcFromMembers();
        alert("History imported. Latest week per member is now loaded.");
      };
      reader.readAsArrayBuffer(file);
    }

    /* ---------- EXPORT XLSX (Summary + Members history) ---------- */

    function exportToExcel() {
      const week = document.getElementById("weekInput").value.trim();
      const team = document.getElementById("teamInput").value.trim();

      if (!team) {
        alert("Please enter a team name before exporting.");
        return;
      }
      if (!week) {
        alert("Please enter a week before exporting.");
        return;
      }

      // Build workbook
      const wb = XLSX.utils.book_new();

      // Summary sheet only for current week
      const summaryData = [
        ["Workbalance ‚Äì TRATON"],
        [],
        ["Team", team],
        ["Week", week],
        [],
        ["Area","Blue (excellent)","Green (good)","Yellow (insufficient)","Red (poor)"]
      ];
      areas.forEach(a => {
        const d = areaData[a];
        summaryData.push([a, d.blue, d.green, d.yellow, d.red]);
      });
      summaryData.push(["Total", overall.blue, overall.green, overall.yellow, overall.red]);
      const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

      // Members sheet ‚Äì historyRows + current week rows (replace existing rows for same week+team)
      const keyFor = r => (r.Team || "") + "||" + (r.Week || "");

      const currentKey = team + "||" + week;
      const preserved = historyRows.filter(r => keyFor(r) !== currentKey);

      const header = ["Week","Team","Member","Manageability","Comprehensibility","Meaningfulness","Recovery","Emojis"];
      const rows = [header];

      // old rows
      preserved.forEach(r => {
        rows.push([
          r.Week || "",
          r.Team || "",
          r.Member || "",
          r.Manageability || "",
          r.Comprehensibility || "",
          r.Meaningfulness || "",
          r.Recovery || "",
          r.Emojis || ""
        ]);
      });

      // new rows for this week
      members.forEach(m => {
        rows.push([
          week,
          team,
          m.name,
          m.ratings["Manageability"] || "",
          m.ratings["Comprehensibility"] || "",
          m.ratings["Meaningfulness"] || "",
          m.ratings["Recovery"] || "",
          m.emojis || ""
        ]);
      });

      const wsMembers = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, wsMembers, "Members");

      // update in-memory history for future imports
      historyRows = XLSX.utils.sheet_to_json(wsMembers, { defval: "" });

      const safeTeam = team.replace(/\s+/g,"_");
      const fileName = (safeTeam || "team") + "_workbalance.xlsx";
      XLSX.writeFile(wb, fileName);
    }

    function updateAllHistoryBadges() {
      // re-render only history column
      const tbody = document.querySelector("#membersTable tbody");
      const team = document.getElementById("teamInput").value.trim();
      Array.from(tbody.rows).forEach((tr, idx) => {
        const m = members[idx];
        const histHtml = buildHistorySummary(m.name, team);
        tr.cells[6].innerHTML = histHtml;
      });
    }

    function showMainEmojiToast() {
      // (no longer used ‚Äì emojis removed from main view, but left stub in case)
    }

    window.addEventListener("DOMContentLoaded", () => {
      initAreas();
    });

    // When team changes we want history badges to recalc
    document.addEventListener("input", e => {
      if (e.target && e.target.id === "teamInput") {
        updateAllHistoryBadges();
      }
    });
  </script>
</body>
</html>
