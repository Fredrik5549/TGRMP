<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Workbalance â€“ TRATON (Members-as-rows / Weeks-as-columns)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* (Samma visuella stil som tidigare, hÃ¥lls kompakt hÃ¤r) */
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f5f7 url("PMO_mission.png") center/cover fixed no-repeat;margin:0;padding:20px;color:#12213b}
    .page-shell{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.92);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.15)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .logo-wrapper img{height:44px}
    h1{margin:0;font-size:28px}
    .traton-label{font-size:12px;color:#555;letter-spacing:1px;text-transform:uppercase}
    .intro-block{margin:10px 0;font-size:14px}
    .helper-link{color:#1a73e8;text-decoration:underline;cursor:pointer}
    .circle-layout{display:flex;justify-content:center;margin-top:8px;margin-bottom:10px}
    .circle-wrapper{position:relative;max-width:640px;width:100%}
    #mainCircleImg{width:100%;max-width:560px;display:block;margin:0 auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .area-overlay-box{position:absolute;background:rgba(255,255,255,.9);border-radius:8px;padding:6px;font-size:14px;display:flex;align-items:center;justify-content:center;min-width:64px}
    #overlay-Manageability{top:8%;left:8%}
    #overlay-Comprehensibility{top:8%;right:8%}
    #overlay-Meaningfulness{bottom:10%;left:8%}
    #overlay-Recovery{bottom:10%;right:8%}
    .area-card{position:absolute;width:180px;background:#fff;border-radius:8px;padding:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);font-size:12px}
    #card-Manageability{top:-6px;left:-4%}
    #card-Comprehensibility{top:-6px;right:-4%}
    #card-Meaningfulness{bottom:36px;left:-4%}
    #card-Recovery{bottom:36px;right:-4%}
    .color-btn{border:0;border-radius:6px;padding:4px 8px;color:#fff;cursor:pointer;font-size:12px;margin-right:6px}
    .blue{background:#2b6cb0}.green{background:#38a169}.yellow{background:#ecc94b;color:#000}.red{background:#e53e3e}
    .workload-avg-box{position:absolute;top:50%;right:-12%;transform:translateY(-50%);background:rgba(255,255,255,.95);padding:6px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08);text-align:center;font-size:12px;width:80px}
    .members-section{margin-top:12px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);display:none}
    table.members-table{width:100%;border-collapse:collapse;font-size:12px}
    table.members-table th,table.members-table td{border:1px solid #ddd;padding:4px;text-align:center}
    table.members-table th{background:#12213b;color:#fff;position:sticky;top:0}
    .members-table-container{max-height:200px;overflow:auto;margin-top:8px}
    .global-import-controls{display:flex;gap:8px;align-items:center;margin-top:10px}
    .fun-row{display:flex;gap:8px;justify-content:center;margin-top:12px}
    .fun-row button{padding:8px 12px;border-radius:16px;border:0;color:#fff;cursor:pointer}
    .fun-celebrate{background:linear-gradient(135deg,#ff9800,#f44336)}
    .bottom-meta{margin-top:12px;padding:10px;background:#fff;border-radius:8px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
    .export-container input{padding:6px;border-radius:6px;border:1px solid #ddd}
    .history-circles{margin-top:14px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .history-circle-img{width:180px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.12)}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000}
    .modal{background:#fff;padding:18px;border-radius:10px;max-width:720px;max-height:84vh;overflow:auto}
    @media(max-width:800px){.logo-wrapper img{height:34px}.workload-avg-box{position:static;margin:8px auto}}
  </style>

  <!-- ExcelJS + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-wrapper"><img src="Traton_logo.png" alt="TRATON logo"></div>
      <div>
        <h1>Workbalance</h1>
        <div class="traton-label">TRATON GROUP â€“ WORK BALANCE DIALOGUE</div>
      </div>
    </header>

    <div class="intro-block">
      <div class="intro-text">
        Workbalance is a support for dialogue in the team about how sustainable the work situation is.
        You rate Manageability, Comprehensibility, Meaningfulness and Recovery using blue/green/yellow/red.
      </div>
      <div><span class="helper-link" onclick="openUsageInfo()">How to use this page</span></div>
    </div>

    <div class="circle-layout">
      <div class="circle-wrapper">
        <img id="mainCircleImg" src="workbalance_circle.png" alt="workbalance circle">
        <div class="area-overlay-box" id="overlay-Manageability"></div>
        <div class="area-overlay-box" id="overlay-Comprehensibility"></div>
        <div class="area-overlay-box" id="overlay-Meaningfulness"></div>
        <div class="area-overlay-box" id="overlay-Recovery"></div>

        <div class="workload-avg-box" id="workloadAvgBox">
          <div style="font-weight:bold">Workload</div>
          <div style="height:80px;width:14px;margin:6px auto;border-radius:8px;border:1px solid #ccc;background:linear-gradient(to top,#f44336,#ffeb3b,#4caf50);position:relative;overflow:hidden">
            <div id="workloadBarInner" style="position:absolute;left:0;right:0;bottom:0;height:0;background:rgba(18,33,59,.85);border-radius:8px 8px 0 0"></div>
          </div>
          <div id="workloadAvgValue">â€“</div>
        </div>
      </div>
    </div>

    <!-- area cards -->
    <div class="area-card" id="card-Manageability">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Manageability</strong><a style="font-size:11px;color:#1a73e8;cursor:pointer" onclick="openAreaInfo('Manageability')">what it means</a></div>
      <div style="margin-top:6px">
        <button class="color-btn blue" onclick="increment('Manageability','blue')">Blue +1</button>
        <button class="color-btn green" onclick="increment('Manageability','green')">Green +1</button>
        <button class="color-btn yellow" onclick="increment('Manageability','yellow')">Yellow +1</button>
        <button class="color-btn red" onclick="increment('Manageability','red')">Red +1</button>
      </div>
    </div>

    <div class="area-card" id="card-Comprehensibility">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Comprehensibility</strong><a style="font-size:11px;color:#1a73e8;cursor:pointer" onclick="openAreaInfo('Comprehensibility')">what it means</a></div>
      <div style="margin-top:6px">
        <button class="color-btn blue" onclick="increment('Comprehensibility','blue')">Blue +1</button>
        <button class="color-btn green" onclick="increment('Comprehensibility','green')">Green +1</button>
        <button class="color-btn yellow" onclick="increment('Comprehensibility','yellow')">Yellow +1</button>
        <button class="color-btn red" onclick="increment('Comprehensibility','red')">Red +1</button>
      </div>
    </div>

    <div class="area-card" id="card-Meaningfulness">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Meaningfulness</strong><a style="font-size:11px;color:#1a73e8;cursor:pointer" onclick="openAreaInfo('Meaningfulness')">what it means</a></div>
      <div style="margin-top:6px">
        <button class="color-btn blue" onclick="increment('Meaningfulness','blue')">Blue +1</button>
        <button class="color-btn green" onclick="increment('Meaningfulness','green')">Green +1</button>
        <button class="color-btn yellow" onclick="increment('Meaningfulness','yellow')">Yellow +1</button>
        <button class="color-btn red" onclick="increment('Meaningfulness','red')">Red +1</button>
      </div>
    </div>

    <div class="area-card" id="card-Recovery">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Recovery</strong><a style="font-size:11px;color:#1a73e8;cursor:pointer" onclick="openAreaInfo('Recovery')">what it means</a></div>
      <div style="margin-top:6px">
        <button class="color-btn blue" onclick="increment('Recovery','blue')">Blue +1</button>
        <button class="color-btn green" onclick="increment('Recovery','green')">Green +1</button>
        <button class="color-btn yellow" onclick="increment('Recovery','yellow')">Yellow +1</button>
        <button class="color-btn red" onclick="increment('Recovery','red')">Red +1</button>
      </div>
    </div>

    <div class="fun-row">
      <button class="fun-celebrate" onclick="runCelebration()">ðŸŽ‰ Celebrate</button>
      <button style="background:#e91e63;color:#fff;border-radius:16px;padding:8px 12px;border:0" onclick="runWarmHug()">ðŸ¤— Warm hug</button>
    </div>

    <!-- members -->
    <div class="members-section" id="membersSection">
      <h3>Team member view (optional)</h3>
      <p style="font-size:13px">Enter members for the selected week. Import/Export uses the Excel file first sheet ("Members"). Each person has 4 rows (one per area) and weeks as columns.</p>

      <div class="members-table-container">
        <table class="members-table" id="membersTable">
          <thead>
            <tr><th>Member</th><th>Manageability</th><th>Comprehensibility</th><th>Meaningfulness</th><th>Recovery</th><th>Workload<br/>(1â€“4)</th><th>Last 2 weeks</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <input id="memberNameInput" placeholder="Member name" style="padding:6px;border:1px solid #ddd;border-radius:6px"/>
        <button onclick="addMember()" style="padding:6px 10px;background:#12213b;color:#fff;border-radius:6px;border:0">Add member</button>
      </div>
    </div>

    <div class="global-import-controls">
      <button onclick="triggerGlobalImport()" style="padding:8px;border-radius:8px;background:#1a73e8;color:#fff;border:0">Import from Excel (history file)</button>
      <div style="font-size:13px;color:#555">The Members sheet uses Member / Area rows, and week columns (YYWW). Import will include any prefilled future weeks.</div>
      <input id="globalMemberFileInput" type="file" accept=".xlsx" style="display:none" onchange="handleGlobalImportFile(this.files[0])">
    </div>

    <div class="bottom-meta">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div>
          <label>Team name</label><br/>
          <input id="teamInput" placeholder="Team name" style="padding:6px;border-radius:6px;border:1px solid #ddd" />
        </div>
        <div>
          <label>Year / Week (YYWW)</label><br/>
          <select id="yearSelect" style="padding:6px;border-radius:6px;border:1px solid #ddd"></select>
          <select id="weekSelect" style="padding:6px;border-radius:6px;border:1px solid #ddd"></select>
          <input id="weekCodeDisplay" readonly style="padding:6px;border-radius:6px;border:1px solid #eee;background:#f3f3f3;width:70px;margin-left:6px"/>
        </div>
      </div>

      <div class="export-container">
        <input id="exportFileName" placeholder="optional filename.xlsx" style="padding:6px;border-radius:6px;border:1px solid #ddd;margin-right:8px"/>
        <button onclick="exportToExcel()" style="padding:8px 12px;border-radius:8px;background:#12213b;color:#fff;border:0">Export to Excel</button>
      </div>
    </div>

    <div id="historyCirclesContainer" class="history-circles"></div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop"><div class="modal" id="modal"><span style="float:right;cursor:pointer" onclick="closeModal()">&times;</span><div id="modalContent"></div></div></div>

<script>
/* ---------- data / text ---------- */
const AREAS = ["Manageability","Comprehensibility","Meaningfulness","Recovery"];
const areaInfo = {
  "Manageability": {definition:"Manageability = balance between demands & resources"},
  "Comprehensibility": {definition:"Comprehensibility = clarity and coherence"},
  "Meaningfulness": {definition:"Meaningfulness = appreciation and engagement"},
  "Recovery": {definition:"Recovery = ability to rest and recover"}
};
let areaData = {}, overall = {blue:0,green:0,yellow:0,red:0};
let members = []; // {name, ratings:{}, workload}
let historyRows = []; // {Week, Team, Member, Manageability,...}
let lastImportedFilename = null;

/* ---------- UI helpers ---------- */
function openModal(html){document.getElementById('modalContent').innerHTML=html;document.getElementById('modalBackdrop').style.display='flex'}
function closeModal(){document.getElementById('modalBackdrop').style.display='none'}
function openUsageInfo(){ openModal('<h3>How to use</h3><p>Import / Export uses Members sheet: Member, Area, weeks as columns (YYWW). Each person 4 rows (one per area).</p>') }
function openAreaInfo(a){ openModal('<h3>'+a+'</h3><p>'+areaInfo[a].definition+'</p>') }

/* ---------- init ---------- */
function init() {
  AREAS.forEach(a=>areaData[a]={blue:0,green:0,yellow:0,red:0});
  initYearWeekSelectors();
  updateAreaOverlays();
}
function initYearWeekSelectors(){
  const yearSelect = document.getElementById('yearSelect'), weekSelect = document.getElementById('weekSelect');
  const now=new Date(), cy=now.getFullYear();
  [cy-1,cy,cy+1].forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y;if(y===cy) o.selected=true;yearSelect.appendChild(o)});
  for(let w=1;w<=53;w++){const o=document.createElement('option');o.value=w;o.textContent=String(w).padStart(2,'0');weekSelect.appendChild(o)}
  weekSelect.value=getISOWeek(now); updateWeekCodeDisplay();
  yearSelect.addEventListener('change',updateWeekCodeDisplay); weekSelect.addEventListener('change',updateWeekCodeDisplay);
}
function getISOWeek(date){
  const tmp=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=tmp.getUTCDay()||7; tmp.setUTCDate(tmp.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1)); return Math.ceil((((tmp-yearStart)/86400000)+1)/7);
}
function getYearWeekCode(){ const y=parseInt(document.getElementById('yearSelect').value,10); const w=parseInt(document.getElementById('weekSelect').value,10); if(!y||!w) return ''; return String(y%100).padStart(2,'0') + String(w).padStart(2,'0'); }
function updateWeekCodeDisplay(){ document.getElementById('weekCodeDisplay').value = getYearWeekCode(); }
function setYearWeekFromCode(code){ if(!/^\d{4}$/.test(code)) return; const yy=parseInt(code.slice(0,2),10), ww=parseInt(code.slice(2,4),10); const year=2000+yy; const ys=document.getElementById('yearSelect'); const ws=document.getElementById('weekSelect'); if(![...ys.options].some(o=>parseInt(o.value,10)===year)){ const o=document.createElement('option'); o.value=year; o.textContent=year; ys.appendChild(o) } ys.value=year; ws.value=ww; updateWeekCodeDisplay(); }
function incrementWeekCode(code){ if(!/^\d{4}$/.test(code)) return code; let yy=parseInt(code.slice(0,2),10), ww=parseInt(code.slice(2,4),10); ww++; if(ww>53){ ww=1; yy++; if(yy>99) yy=0 } return String(yy).padStart(2,'0')+String(ww).padStart(2,'0') }

/* ---------- area counting & overlay ---------- */
function increment(area, color){ areaData[area][color]++; overall[color]++; updateAreaOverlays(); }
function updateAreaOverlays(){
  AREAS.forEach(a=>{
    const el = document.getElementById('overlay-'+a);
    if(!el) return;
    const d = areaData[a];
    el.innerHTML = makeStatusIcons(d);
  });
}
function makeStatusIcons(d){
  const total=(d.blue||0)+(d.green||0)+(d.yellow||0)+(d.red||0);
  if(!total) return 'â€“';
  const tokens=[]; function add(sym,count){for(let i=0;i<count;i++) tokens.push(sym)}
  add('ðŸ”µ',d.blue||0); add('ðŸŸ¢',d.green||0); add('ðŸŸ¡',d.yellow||0); add('ðŸ”´',d.red||0);
  let html=''; tokens.forEach((t,i)=>{ if(i>0 && i%5===0) html+='<br>'; html+=t });
  const extra = total - tokens.length; if(extra>0) html += ' +' + extra;
  return html;
}

/* ---------- members table ---------- */
function addMember(){ const n=document.getElementById('memberNameInput').value.trim(); if(!n) return; members.push({name:n,ratings:{},workload:null}); document.getElementById('memberNameInput').value=''; renderMembersTable(); recalcFromMembers(); }
function removeMember(i){ members.splice(i,1); renderMembersTable(); recalcFromMembers(); }
function renderMembersTable(){
  const tbody = document.querySelector('#membersTable tbody'); tbody.innerHTML='';
  const team = document.getElementById('teamInput').value.trim();
  members.forEach((m,idx)=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.textContent=m.name; tr.appendChild(tdName);
    AREAS.forEach(a=>{
      const td=document.createElement('td'); const sel=document.createElement('select'); ['','blue','green','yellow','red'].forEach(v=>{const o=document.createElement('option'); o.value=v; o.textContent = v? (v==='blue'?'ðŸ”µ':v==='green'?'ðŸŸ¢':v==='yellow'?'ðŸŸ¡':'ðŸ”´') : ''; if(m.ratings[a]===v) o.selected=true; sel.appendChild(o) });
      sel.addEventListener('change',()=>{ m.ratings[a]=sel.value; recalcFromMembers(); });
      td.appendChild(sel); tr.appendChild(td);
    });
    const tdW=document.createElement('td'); const selW=document.createElement('select'); ['','1','2','3','4'].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v; if(String(m.workload||'')===v) o.selected=true; selW.appendChild(o)}); selW.addEventListener('change',()=>{ m.workload=selW.value?parseInt(selW.value,10):null; updateWorkloadOverlay() }); tdW.appendChild(selW); tr.appendChild(tdW);
    const tdHist=document.createElement('td'); tdHist.innerHTML = buildRecentTwoWeeksStatus(m.name,team); tr.appendChild(tdHist);
    const tdRem=document.createElement('td'); const btn=document.createElement('button'); btn.textContent='X'; btn.style.background='#e53e3e'; btn.style.color='#fff'; btn.onclick=()=>removeMember(idx); tdRem.appendChild(btn); tr.appendChild(tdRem);
    tbody.appendChild(tr);
  });
}

/* 2 latest weeks */
function buildRecentTwoWeeksStatus(name, team) {
  if(!historyRows.length) return '';
  const rows = historyRows.filter(r=>r.Member===name && r.Team===team);
  if(!rows.length) return '';
  const seen=new Set(); const picked=[];
  for(let i=rows.length-1;i>=0;i--){ const r=rows[i]; const w=(r.Week||'').toString(); if(!w) continue; if(!seen.has(w)){ seen.add(w); picked.push(r); if(picked.length===2) break } }
  picked.reverse();
  return picked.map(r=>{ const w=(r.Week||'').toString(); return `<div style="font-size:12px"><strong>${w}</strong> M:${mapDot(r.Manageability)} C:${mapDot(r.Comprehensibility)} Me:${mapDot(r.Meaningfulness)} R:${mapDot(r.Recovery)}</div>` }).join('');
}
function mapDot(c){ c=(c||'').toLowerCase(); if(c==='blue') return 'ðŸ”µ'; if(c==='green') return 'ðŸŸ¢'; if(c==='yellow') return 'ðŸŸ¡'; if(c==='red') return 'ðŸ”´'; return 'âšª' }

/* recalc totals */
function recalcFromMembers(){
  AREAS.forEach(a=>areaData[a]={blue:0,green:0,yellow:0,red:0}); overall={blue:0,green:0,yellow:0,red:0};
  members.forEach(m=>{ AREAS.forEach(a=>{ const c=(m.ratings[a]||'').toLowerCase(); if(c && areaData[a][c]!==undefined){ areaData[a][c]++; overall[c]++; } }) });
  updateAreaOverlays(); updateWorkloadOverlay(); renderHistoryCirclesForTeam(document.getElementById('teamInput').value.trim());
}

/* workload overlay */
function updateWorkloadOverlay(){
  const bar=document.getElementById('workloadBarInner'), val=document.getElementById('workloadAvgValue');
  let sum=0,count=0; members.forEach(m=>{ if(typeof m.workload==='number'){ sum+=m.workload; count++ } });
  if(!count){ bar.style.height='0%'; val.textContent='â€“'; return }
  const avg=sum/count; bar.style.height = Math.min(100,Math.max(0,(avg/4)*100)) + '%'; val.textContent = avg.toFixed(1) + ' / 4';
}

/* history circles rendering (simple) */
function renderHistoryCirclesForTeam(team){
  const container=document.getElementById('historyCirclesContainer'); container.innerHTML='';
  if(!team || !historyRows.length) return;
  const rows = historyRows.filter(r=> (r.Team||'')===team );
  if(!rows.length) return;
  const weeksOrder = [];
  rows.forEach(r=>{ const w=(r.Week||'').toString(); if(!w) return; if(!weeksOrder.includes(w)) weeksOrder.push(w) });
  if(!weeksOrder.length) return;
  const selected = weeksOrder.slice(-4);
  selected.forEach(w=>{
    const weekData={}; AREAS.forEach(a=>weekData[a]={blue:0,green:0,yellow:0,red:0});
    rows.forEach(r=>{ if(r.Week===w){ AREAS.forEach(a=>{ const c=(r[a]||'').toLowerCase(); if(weekData[a][c]!==undefined) weekData[a][c]++ }) } });
    const block=document.createElement('div'); block.style.textAlign='center';
    const label=document.createElement('div'); label.style.fontWeight='bold'; label.textContent='Week '+w; block.appendChild(label);
    const img=document.createElement('img'); img.src='workbalance_circle.png'; img.className='history-circle-img'; img.alt='circle '+w; block.appendChild(img);
    const ov=document.createElement('div'); ov.style.marginTop='6px'; ov.innerHTML = AREAS.map(a=>`<div style="font-size:12px"><strong>${a}:</strong> ${makeStatusIcons(weekData[a])}</div>`).join(''); block.appendChild(ov);
    container.appendChild(block);
  });
}

/* ---------- IMPORT (Members sheet: Member | Area | YYWW... ) ---------- */
async function handleMemberFileImport(file) {
  if(!file) return;
  lastImportedFilename = file.name || null;
  try {
    const arrayBuffer = await file.arrayBuffer();
    const wb = new ExcelJS.Workbook();
    await wb.xlsx.load(arrayBuffer);

    // Read Members sheet (must be first sheet or named 'Members')
    let ws = wb.getWorksheet('Members') || wb.worksheets[0];
    if(!ws){ alert('No sheet found in file'); return; }

    // read header row for week columns
    const header = ws.getRow(1).values.slice(1).map(v=> (v||'').toString().trim() );
    // Member col index (0-based) = 0, Area col =1; if file includes Team col we'll detect later
    let memberCol = 0, areaCol = 1, teamCol = -1;
    // detect if header includes 'Team' in col 2
    header.forEach((h,i)=>{ if(/team/i.test(h)) teamCol = i });
    // week columns are those after member & area (and team if present)
    const weekCols = [];
    header.forEach((h,i)=>{
      if(i===memberCol || i===areaCol || i===teamCol) return;
      if(/^\d{4}$/.test(h)) weekCols.push({colIndex:i+1, code:h});
    });
    if(!weekCols.length){
      alert('Imported Members sheet must have week-columns in YYWW (e.g. 2552).');
      return;
    }

    // parse rows: each row is one Member+Area, we collect per Member+Week aggregated areas
    const temp = {}; // key = Member|Week => {Member, Team, Week, Manageability,Comprehensibility,Meaningfulness,Recovery,Workload}
    ws.eachRow((row,rnum)=>{
      if(rnum===1) return;
      const cells = row.values.slice(1);
      const member = String(cells[memberCol]||'').trim();
      const area = String(cells[areaCol]||'').trim();
      const team = (teamCol>=0) ? String(cells[teamCol]||'').trim() : (document.getElementById('teamInput').value || '');
      if(!member || !area) return;
      weekCols.forEach(wc=>{
        const cell = row.getCell(wc.colIndex).value;
        if(cell===undefined || cell===null || String(cell).trim()==='') return; // not filled
        // cell expected to be either color name (blue/green/...) or encoded "Manageability:blue;..."
        const s = String(cell).trim();
        let parsed = {Manageability:'',Comprehensibility:'',Meaningfulness:'',Recovery:'',Workload:''};
        if(/[:;]/.test(s)){
          // parse encoded pairs
          s.split(/[;,]+/).forEach(part=>{
            const m = part.split(/[:=]/); if(m.length<2) return;
            const key = m[0].trim().toLowerCase(); const val = m[1].trim().toLowerCase();
            if(/manage/i.test(key)) parsed.Manageability = val;
            if(/comp/i.test(key)) parsed.Comprehensibility = val;
            if(/mean/i.test(key)) parsed.Meaningfulness = val;
            if(/recov/i.test(key)) parsed.Recovery = val;
            if(/work/i.test(key)) parsed.Workload = val;
          });
        } else {
          // single color -> apply to that area row only (we will set that area value)
          // Because sheet layout is per-area row, single color usually means the value for that area
          // So map area name to parsed field:
          const color = s.toLowerCase();
          if(['blue','green','yellow','red'].includes(color)){
            if(/manage/i.test(area)) parsed.Manageability = color;
            else if(/comp/i.test(area)) parsed.Comprehensibility = color;
            else if(/mean/i.test(area)) parsed.Meaningfulness = color;
            else if(/recov/i.test(area)) parsed.Recovery = color;
            else {
              // unknown area label -> try map by exact match
              if(area === 'Manageability') parsed.Manageability = color;
              if(area === 'Comprehensibility') parsed.Comprehensibility = color;
              if(area === 'Meaningfulness') parsed.Meaningfulness = color;
              if(area === 'Recovery') parsed.Recovery = color;
            }
          } else {
            // not a recognized token -> skip
            return;
          }
        }

        const key = member + '||' + wc.code + '||' + team;
        if(!temp[key]) temp[key] = { Week: wc.code, Team: team, Member: member, Manageability:'', Comprehensibility:'', Meaningfulness:'', Recovery:'', Workload:''};
        // fill non-empty parsed fields
        Object.keys(parsed).forEach(k=>{ if(parsed[k]) temp[key][k] = parsed[k]; });
      });
    });

    // convert temp -> historyRows array (only include entries where at least one area is set)
    const rows = Object.values(temp).filter(r => (r.Manageability||r.Comprehensibility||r.Meaningfulness||r.Recovery) );
    if(!rows.length){
      alert('No filled status cells were found in the Members sheet.');
      return;
    }

    // sort by Week, then Member
    rows.sort((a,b)=>{ if(a.Week===b.Week) return a.Member.localeCompare(b.Member); return a.Week.localeCompare(b.Week) });

    historyRows = rows.slice();

    // set team input to first row's team if empty
    if(historyRows.length) document.getElementById('teamInput').value = document.getElementById('teamInput').value || (historyRows[historyRows.length-1].Team || '');

    // set week selector to next week after max week found in the sheet
    const weeksFound = Array.from(new Set(rows.map(r=>String(r.Week||'')))).filter(w=>/^\d{4}$/.test(w)).sort();
    const maxWeek = weeksFound[weeksFound.length-1];
    if(maxWeek) setYearWeekFromCode(incrementWeekCode(maxWeek));
    else updateWeekCodeDisplay();

    // Populate members list with all distinct members present in the file (so future prefills are visible in history and table)
    const names = Array.from(new Set(rows.map(r=>r.Member))).sort();
    members = names.map(n=>({name:n, ratings:{}, workload:null}));

    // clear current-week ratings (we keep workspace empty so user can fill)
    renderMembersTable();
    recalcFromMembers();
    renderHistoryCirclesForTeam(document.getElementById('teamInput').value || '');

    alert('Import complete: ' + rows.length + ' entries loaded (includes future weeks that were filled).');
  } catch (err){
    console.error(err);
    alert('Import failed: ' + (err && err.message?err.message:err));
  }
}

function triggerGlobalImport(){ document.getElementById('globalMemberFileInput').click(); }
function handleGlobalImportFile(file){ if(!file) return; handleMemberFileImport(file); document.getElementById('globalMemberFileInput').value=''; }

/* ---------- EXPORT ---------- */
async function exportToExcel(){
  const team = document.getElementById('teamInput').value.trim();
  const weekCode = getYearWeekCode();
  if(!team){ alert('Please enter a team name before exporting.'); return; }
  if(!/^\d{4}$/.test(weekCode)){ alert('Please select a valid year and week (YYWW).'); return; }

  // Build membersMap from historyRows + current members
  const membersMap = {}; // name -> {Team, areasByWeek: {week: {Manageability,Comprehensibility,Meaningfulness,Recovery,Workload}}}
  (historyRows||[]).forEach(r=>{
    const name=r.Member||''; if(!name) return;
    if(!membersMap[name]) membersMap[name] = {Team: r.Team || team, weeks: {}};
    membersMap[name].weeks[r.Week] = {
      Manageability: r.Manageability||'',
      Comprehensibility: r.Comprehensibility||'',
      Meaningfulness: r.Meaningfulness||'',
      Recovery: r.Recovery||'',
      Workload: r.Workload||''
    };
  });
  members.forEach(m=>{
    if(!m.name) return;
    if(!membersMap[m.name]) membersMap[m.name] = {Team: team, weeks: {}};
    // current week values (will overwrite existing if present)
    membersMap[m.name].weeks[weekCode] = {
      Manageability: m.ratings['Manageability'] || '',
      Comprehensibility: m.ratings['Comprehensibility'] || '',
      Meaningfulness: m.ratings['Meaningfulness'] || '',
      Recovery: m.ratings['Recovery'] || '',
      Workload: m.workload != null ? String(m.workload) : ''
    };
  });

  // Determine existing weeks from history + include upcoming 52 weeks (YYWW) from current date
  const existingWeeks = Array.from(new Set([].concat((historyRows||[]).map(r=>r.Week||''), Object.keys(membersMap).flatMap(n=>Object.keys(membersMap[n].weeks || {}))))).filter(Boolean);
  // compute next 52 weeks YYWW starting from current ISO week
  const next52 = generateNextWeeks(52);
  next52.forEach(w=>{ if(!existingWeeks.includes(w)) existingWeeks.push(w) });
  existingWeeks.sort();

  // Create workbook
  try{
    const wb = new ExcelJS.Workbook(); wb.creator='Workbalance tool'; wb.created=new Date();

    // Lists sheet
    const lists = wb.addWorksheet('Lists'); lists.getCell('A1').value='blue'; lists.getCell('A2').value='green'; lists.getCell('A3').value='yellow'; lists.getCell('A4').value='red';

    // Members sheet: Member | Area | week columns (YYWW)
    const membersSheet = wb.addWorksheet('Members');
    const header = ['Member','Area', ...existingWeeks];
    membersSheet.addRow(header);

    Object.keys(membersMap).sort().forEach(name=>{
      const mp = membersMap[name];
      AREAS.forEach(area=>{
        const row = [name, area];
        existingWeeks.forEach(w=>{
          const wk = (mp.weeks && mp.weeks[w]) || null;
          if(!wk) row.push('');
          else {
            const encoded = `Manageability:${wk.Manageability||''};Comprehensibility:${wk.Comprehensibility||''};Meaningfulness:${wk.Meaningfulness||''};Recovery:${wk.Recovery||''};Workload:${wk.Workload||''}`;
            row.push(encoded);
          }
        });
        membersSheet.addRow(row);
      });
    });

    // MembersDetails sheet (row-per-member-week) for compatibility and easier editing
    const details = wb.addWorksheet('MembersDetails');
    details.addRow(['Week','Team','Member','Manageability','Comprehensibility','Meaningfulness','Recovery','Workload']);
    Object.keys(membersMap).sort().forEach(name=>{
      const mp = membersMap[name];
      Object.keys(mp.weeks).forEach(w=>{
        const wk = mp.weeks[w];
        details.addRow([w, mp.Team || team, name, wk.Manageability||'', wk.Comprehensibility||'', wk.Meaningfulness||'', wk.Recovery||'', wk.Workload||'']);
      });
    });

    // Apply validation (list) on details sheet columns D..G
    for(let r=2;r<=details.rowCount;r++){
      for(let c=4;c<=7;c++){
        const cell = details.getRow(r).getCell(c);
        cell.dataValidation = {
          type: 'list',
          allowBlank: true,
          formulae: ['=Lists!$A$1:$A$4'],
          showErrorMessage: true
        };
      }
    }

    // Summary and CircleSnapshot (attempt to embed)
    const sum = wb.addWorksheet('Summary');
    sum.addRow(['Workbalance â€“ TRATON']); sum.addRow([]); sum.addRow(['Team', team]); sum.addRow(['Week (YYWW)', weekCode]); sum.addRow([]);
    sum.addRow(['Area','Blue','Green','Yellow','Red']);
    AREAS.forEach(a=>{ const d = areaData[a] || {blue:0,green:0,yellow:0,red:0}; sum.addRow([a,d.blue,d.green,d.yellow,d.red]) });
    sum.addRow(['Total', overall.blue, overall.green, overall.yellow, overall.red]);

    const snap = wb.addWorksheet('CircleSnapshot');
    // attempt to embed image from DOM
    try{
      const imgEl = document.getElementById('mainCircleImg');
      const canvas = document.createElement('canvas');
      canvas.width = imgEl.naturalWidth || imgEl.width || 800;
      canvas.height = imgEl.naturalHeight || imgEl.height || 800;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(imgEl,0,0,canvas.width,canvas.height);
      const dataUrl = canvas.toDataURL('image/png');
      const base64 = dataUrl.split(',')[1];
      const imgId = wb.addImage({ base64: base64, extension: 'png' });
      snap.addImage(imgId, { tl: { col: 0.2, row: 0.2 }, ext: { width: 720, height: 720 } });
    } catch(e){
      snap.getCell('A1').value = 'Could not embed circle image (possible CORS).';
    }
    snap.getCell('H2').value = 'Areas explanation';
    snap.getCell('H3').value = 'Manageability: ' + areaInfo.Manageability.definition;
    snap.getCell('H4').value = 'Comprehensibility: ' + areaInfo.Comprehensibility.definition;
    snap.getCell('H5').value = 'Meaningfulness: ' + areaInfo.Meaningfulness.definition;
    snap.getCell('H6').value = 'Recovery: ' + areaInfo.Recovery.definition;

    // Save file (use specified filename or default team_workbalance.xlsx or lastImportedFilename)
    let fileName = document.getElementById('exportFileName').value.trim();
    if(!fileName) fileName = lastImportedFilename ? lastImportedFilename : (team.replace(/\s+/g,'_') + '_workbalance.xlsx');
    if(!fileName.toLowerCase().endsWith('.xlsx')) fileName += '.xlsx';
    const buffer = await wb.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    saveAs(blob, fileName);

    // update in-memory historyRows from details sheet we just wrote (so later imports/exports align)
    const exported = [];
    details.eachRow((row,rnum)=>{ if(rnum===1) return; const v = row.values.slice(1); exported.push({Week:String(v[0]||''),Team:String(v[1]||''),Member:String(v[2]||''),Manageability:String(v[3]||''),Comprehensibility:String(v[4]||''),Meaningfulness:String(v[5]||''),Recovery:String(v[6]||''),Workload:String(v[7]||'')}) });
    historyRows = exported;
    lastImportedFilename = fileName;
    alert('Exported ' + fileName);
  } catch(err){
    console.error(err); alert('Export failed: ' + (err && err.message?err.message:err));
  }
}

/* ---------- generate next N weeks YYWW starting from current week ---------- */
function generateNextWeeks(n){
  const res=[];
  const now=new Date();
  let curYear=now.getFullYear(), curWeek=getISOWeek(now);
  for(let i=0;i<n;i++){
    const yy = String(curYear%100).padStart(2,'0'), ww=String(curWeek).padStart(2,'0');
    res.push(yy+ww);
    curWeek++;
    if(curWeek>53){ curWeek=1; curYear++;}
  }
  return res;
}

/* ---------- fun effects ---------- */
function runCelebration(){ if(typeof confetti==='undefined'){ alert('No confetti lib'); return } const dt=Date.now()+2200; (function f(){ confetti({particleCount:12,spread:60,origin:{y:0.6}}); if(Date.now()<dt) requestAnimationFrame(f); })() }
function runWarmHug(){ spawnEmoji(['ðŸ¤—','â¤ï¸','âœ¨','ðŸ¤'],38) }
function spawnEmoji(list,count=30){ const overlay=document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='0'; overlay.style.pointerEvents='none'; overlay.style.zIndex='1500'; document.body.appendChild(overlay); for(let i=0;i<count;i++){ const s=document.createElement('div'); s.textContent=list[Math.floor(Math.random()*list.length)]; s.style.position='absolute'; s.style.left=Math.random()*100+'%'; s.style.top='100%'; s.style.fontSize=(18+Math.random()*36)+'px'; s.style.transition='transform 3s linear, opacity 3s linear'; overlay.appendChild(s); setTimeout(()=>{ s.style.transform='translateY(-140vh)'; s.style.opacity='0' }, 50+Math.random()*800); } setTimeout(()=>document.body.removeChild(overlay),3800) }

/* ---------- wire up inputs ---------- */
document.getElementById('globalMemberFileInput').addEventListener('change', e=>{ if(e.target.files.length) handleMemberFileImport(e.target.files[0]); });
document.getElementById('toggleMembers')?.addEventListener('change', e=>{ document.getElementById('membersSection').style.display = e.target.checked ? 'block' : 'none' });

/* ---------- init call ---------- */
window.addEventListener('DOMContentLoaded', init);
</script>

<!-- FileSaver -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</body>
</html>
