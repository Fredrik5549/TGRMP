<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workbalance ‚Äì TRATON (history + import/export v4)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f5f7 url("PMO_mission.png") center/cover fixed no-repeat;
      margin: 0;
      padding: 20px;
      color: #12213b;
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.25);
      padding: 20px 24px 24px 24px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .logo-wrapper img {
      height: 40px;
      width: auto;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      text-align: left;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.5px;
    }

    .traton-label {
      margin-top: 2px;
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
    }

    .intro-block {
      margin: 8px 0 10px 0;
      max-width: 900px;
      font-size: 14px;
    }

    .intro-text {
      margin-bottom: 4px;
    }

    .helper-link {
      font-size: 13px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    /* CIRCLE + AREA CARDS */

    .circle-layout {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      margin-bottom: 24px;
    }

    .circle-layout-inner {
      position: relative;
      max-width: 820px;
      width: 100%;
      min-height: 500px;
      margin: 0 auto;
    }

    .circle-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: inline-block;
    }

    .circle-wrapper img {
      max-width: 560px;
      width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.16);
      display: block;
    }

    .area-overlay-box {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 4px 6px;
      font-size: 16px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      min-width: 80px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
    }

    .overlay-icons span {
      margin: 0 1px;
    }

    #overlay-Manageability { top: 13%; left: 12%; }
    #overlay-Comprehensibility { top: 13%; right: 12%; }
    #overlay-Meaningfulness { bottom: 11%; left: 12%; }
    #overlay-Recovery { bottom: 11%; right: 12%; }

    .area-card {
      position: absolute;
      width: 190px;
      background: #ffffff;
      border-radius: 10px;
      padding: 6px 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 11px;
    }

    .area-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .area-title {
      font-weight: bold;
      font-size: 12px;
    }

    .info-link {
      font-size: 10px;
      text-decoration: underline;
      color: #1a73e8;
      cursor: pointer;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }

    .color-btn {
      border: none;
      padding: 3px 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 10px;
      color: #fff;
      min-width: 52px;
    }

    .blue  { background: #2b6cb0; }
    .green { background: #38a169; }
    .yellow{ background: #ecc94b; color: #000; }
    .red   { background: #e53e3e; }

    .counts {
      font-size: 10px;
    }

    .counts span {
      margin-right: 4px;
    }

    #card-Manageability { top: 6px; left: 0; }
    #card-Comprehensibility { top: 6px; right: 0; }
    #card-Meaningfulness { bottom: 6px; left: 0; }
    #card-Recovery { bottom: 6px; right: 0; }

    /* Team member view */

    .members-toggle {
      margin-top: 20px;
      font-size: 14px;
    }

    .members-section {
      margin-top: 10px;
      padding: 10px 12px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
    }

    .members-section h2 {
      margin-top: 0;
      font-size: 16px;
    }

    .members-section p {
      font-size: 12px;
      margin-top: 4px;
    }

    .member-controls {
      margin-top: 6px;
      margin-bottom: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-controls input {
      padding: 4px 6px;
      font-size: 12px;
    }

    .member-controls button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    .member-file-controls {
      margin: 4px 0 4px 0;
      font-size: 11px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .member-file-controls button {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #1a73e8;
      color: #ffffff;
    }

    .member-file-hint {
      font-size: 11px;
      color: #555;
    }

    .member-help-link {
      font-size: 11px;
      color: #1a73e8;
      text-decoration: underline;
      cursor: pointer;
    }

    table.members-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }

    table.members-table th,
    table.members-table td {
      border: 1px solid #ccc;
      padding: 2px 4px;
      text-align: center;
      line-height: 1.2;
    }

    table.members-table th {
      background: #12213b;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 11px;
      padding: 2px 4px;
    }

    .remove-btn {
      border: none;
      background: #e53e3e;
      color: #fff;
      border-radius: 3px;
      padding: 1px 4px;
      cursor: pointer;
      font-size: 10px;
    }

    .emoji-toggles {
      display: flex;
      gap: 2px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .emoji-toggle {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1px 4px;
      cursor: pointer;
      background: #f9f9f9;
      font-size: 14px;
    }

    .emoji-toggle.active {
      background: #12213b;
      color: #fff;
    }

    .prev-week-cell {
      font-size: 10px;
      line-height: 1.2;
      white-space: nowrap;
    }

    .prev-week-chip {
      display: inline-block;
      margin-right: 8px;
    }

    /* container f√∂r tabellen ‚Äì l√§gre h√∂jd s√• cirkeln syns mer */
    .members-table-container {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 4px;
    }

    /* Bottom ‚Äì Week + Team + Export */

    .bottom-meta {
      margin-top: 20px;
      padding: 10px 12px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    .meta-fields {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .meta-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .meta-fields label {
      font-size: 12px;
    }

    .meta-fields input,
    .meta-fields select {
      padding: 4px 6px;
      font-size: 12px;
      min-width: 80px;
    }

    .export-container button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #12213b;
      color: #ffffff;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #ffffff;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 18px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .modal h3 {
      margin-top: 0;
    }

    .modal section {
      margin-bottom: 10px;
    }

    .modal-close {
      float: right;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }

    @media (max-width: 800px) {
      body { padding: 8px; }
      .page-shell { padding: 14px; }
      header { flex-direction: column; align-items: flex-start; }
      .logo-wrapper img { height: 32px; }
      .circle-layout-inner { min-height: auto; }
      .area-card { position: static; width: 100%; margin-top: 8px; }
      .circle-wrapper {
        position: static;
        transform: none;
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .area-overlay-box { display: none; }
      .bottom-meta { flex-direction: column; align-items: flex-start; }
      .members-table-container { max-height: 220px; }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-wrapper">
        <img src="Traton_logo.png" alt="TRATON Group logo">
      </div>
      <div class="header-text">
        <h1>Workbalance</h1>
        <div class="traton-label">TRATON GROUP ‚Äì WORK BALANCE DIALOGUE</div>
      </div>
    </header>

    <div class="intro-block">
      <div class="intro-text">
        Workbalance is a support for dialogue in the team about how sustainable the work situation is.
        You rate four areas together ‚Äì Manageability, Comprehensibility, Meaningfulness and Recovery ‚Äì
        using the colours blue, green, yellow and red. The model is based on structured reflection and
        shared responsibility: everyone contributes with experiences, the team identifies patterns, and
        you agree on concrete actions to strengthen a healthy balance over time.
      </div>
      <span class="helper-link" onclick="openUsageInfo()">
        How do we use this page?
      </span>
    </div>

    <!-- CIRCLE + AREA CARDS -->
    <div class="circle-layout">
      <div class="circle-layout-inner">
        <div class="circle-wrapper">
          <img src="workbalance_circle.png" alt="Work Balance Model">
          <div class="area-overlay-box" id="overlay-Manageability"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Comprehensibility"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Meaningfulness"><div class="overlay-icons"></div></div>
          <div class="area-overlay-box" id="overlay-Recovery"><div class="overlay-icons"></div></div>
        </div>

        <div class="area-card" id="card-Manageability">
          <div class="area-title-row">
            <div class="area-title">Manageability</div>
            <span class="info-link" onclick="openAreaInfo('Manageability')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Manageability','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Manageability','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Manageability','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Manageability','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Manageability"></div>
        </div>

        <div class="area-card" id="card-Comprehensibility">
          <div class="area-title-row">
            <div class="area-title">Comprehensibility</div>
            <span class="info-link" onclick="openAreaInfo('Comprehensibility')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Comprehensibility','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Comprehensibility','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Comprehensibility','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Comprehensibility','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Comprehensibility"></div>
        </div>

        <div class="area-card" id="card-Meaningfulness">
          <div class="area-title-row">
            <div class="area-title">Meaningfulness</div>
            <span class="info-link" onclick="openAreaInfo('Meaningfulness')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Meaningfulness','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Meaningfulness','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Meaningfulness','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Meaningfulness','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Meaningfulness"></div>
        </div>

        <div class="area-card" id="card-Recovery">
          <div class="area-title-row">
            <div class="area-title">Recovery</div>
            <span class="info-link" onclick="openAreaInfo('Recovery')">What does this mean?</span>
          </div>
          <div class="buttons-row">
            <button class="color-btn blue"   onclick="increment('Recovery','blue')">Blue +1</button>
            <button class="color-btn green"  onclick="increment('Recovery','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Recovery','yellow')">Yellow +1</button>
            <button class="color-btn red"    onclick="increment('Recovery','red')">Red +1</button>
          </div>
          <div class="counts" id="counts-Recovery"></div>
        </div>
      </div>
    </div>

    <!-- TEAM MEMBER VIEW -->
    <div class="members-toggle">
      <label>
        <input type="checkbox" id="toggleMembers" onchange="toggleMembersSection()">
        Add status per team member (optional ‚Äì with weekly history)
      </label>
    </div>

    <div class="members-section" id="membersSection">
      <h2>Team member view (optional)</h2>
      <p>
        Enter one row per team member for the selected week and team.
        When you import an Excel file exported from this page, you restore names and all previous weeks.
        The history column shows the latest two weeks per person, horizontally.
        <span class="member-help-link" onclick="openMemberFileInfo()">
          How does import / export work?
        </span>
      </p>

      <!-- TABLE FIRST so you can see the circle while typing -->
      <div class="members-table-container">
        <table class="members-table" id="membersTable">
          <thead>
            <tr>
              <th>Member</th>
              <th>Manageability</th>
              <th>Comprehensibility</th>
              <th>Meaningfulness</th>
              <th>Recovery</th>
              <th>Support emojis<br/>(üôè ‚ù§Ô∏è üëç)</th>
              <th>Recent weeks<br/>(2 latest, all areas)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="member-controls">
        <input type="text" id="memberNameInput" placeholder="Team member name" />
        <button type="button" onclick="addMember()">Add member</button>
      </div>

      <div class="member-file-controls">
        <button type="button" onclick="document.getElementById('memberFileInput').click()">
          Import from Excel (history file)
        </button>
        <span class="member-file-hint">
          Use an .xlsx file exported from this page to bring back names and all earlier weeks.
        </span>
        <input type="file" id="memberFileInput" accept=".xlsx" style="display:none"
               onchange="handleMemberFileImport(this.files[0])">
      </div>
    </div>

    <!-- WEEK + TEAM + EXPORT -->
    <div class="bottom-meta">
      <div class="meta-fields">
        <div class="meta-group">
          <label for="teamInput">Team name</label>
          <input id="teamInput" type="text" placeholder="e.g. XTRM Platform" />
        </div>
        <div class="meta-group">
          <label>Year / Week (YYWW)</label>
          <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
            <div>
              <span style="font-size:11px;">Year</span><br/>
              <select id="yearSelect"></select>
            </div>
            <div>
              <span style="font-size:11px;">Week</span><br/>
              <select id="weekSelect"></select>
            </div>
            <div>
              <span style="font-size:11px;">Code</span><br/>
              <input id="weekCodeDisplay" type="text" readonly style="background:#f3f3f3;"/>
            </div>
          </div>
        </div>
      </div>
      <div class="export-container">
        <button onclick="exportToExcel()">Export to Excel</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modal">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const areas = ["Manageability","Comprehensibility","Meaningfulness","Recovery"];

    const areaInfo = {
      "Manageability": {
        definition:
          "Manageability is about your overall conditions at work ‚Äì the balance between demands and resources, support, clarity and the possibility to influence.",
        questions: [
          "Do you have sufficient time and resources to complete your duties?",
          "Are the right demands being made of you?",
          "Are you able to influence your work situation?",
          "Can you raise and escalate issues ‚Äì and do you get support when you do?",
          "Do you know what is expected of you and are there working methods that make things easier?"
        ]
      },
      "Comprehensibility": {
        definition:
          "Comprehensibility is the feeling of understanding the organisation‚Äôs goals and how your work contributes. It requires openness and a clear overall picture.",
        questions: [
          "Do you understand what is going on in the organisation?",
          "Do you feel coherence with the organisational goals?",
          "If you have different roles, do they fit together?",
          "Do you feel safe and treated with respect at work?",
          "Do you receive continuous feedback that helps you progress?"
        ]
      },
      "Meaningfulness": {
        definition:
          "Meaningfulness is about being appreciated and included in a fair and stimulating social climate. A high sense of meaningfulness generates motivation and creativity.",
        questions: [
          "Do you feel fairly treated in relation to your colleagues?",
          "Do you feel included in what is going on and encouraged to participate?",
          "Do you receive sufficient acknowledgement and do you celebrate success?",
          "Do you find your work tasks motivating?",
          "Do you follow your personal development plan?"
        ]
      },
      "Recovery": {
        definition:
          "Recovery is about variation in work, the ability to use breaks for movement or rest, and having time for focus and reflection so that energy can be restored.",
        questions: [
          "Can you put work thoughts aside outside working hours?",
          "Can you use breaks at work to relax and recover?",
          "Are you able to move around during breaks?",
          "Do you feel energised coming to work and have energy left when you go home?",
          "Do you have time for reflection and conditions for focused work?"
        ]
      }
    };

    const usageInfo = {
      title: "How to use this page",
      html: `
        <section>
          <strong>1. Decide team and week</strong><br/>
          At the bottom of the page, enter the team name and use the Year/Week selectors to create a week code (YYWW).
        </section>
        <section>
          <strong>2. Rate each area together</strong><br/>
          Click the colour buttons for each area to represent the voices in the team.
          The icons on the circle show how many blue, green, yellow and red you have in that area.
        </section>
        <section>
          <strong>3. Use the team member view when needed</strong><br/>
          Turn on ‚ÄúAdd status per team member‚Äù to rate per person.
          The upper circle is then calculated from the team member statuses for the selected week.
        </section>
        <section>
          <strong>4. Import old weeks</strong><br/>
          Import an Excel file exported from this page to restore names and all previous weeks.
          After import, the week selector is automatically moved to the next week so you can add a new measurement.
        </section>
        <section>
          <strong>5. Export and keep building history</strong><br/>
          ‚ÄúExport to Excel‚Äù saves the current week plus all earlier weeks in one file.
          You can reuse the same file every time to keep the Workbalance history growing.
        </section>
      `
    };

    const memberFileInfo = {
      title: "Import / export for team members",
      html: `
        <section>
          <strong>Excel structure</strong><br/>
          The file contains a sheet called <em>‚ÄúMembers‚Äù</em> with one row per member and week:
          <br/><em>Week, Team, Member, Manageability, Comprehensibility, Meaningfulness, Recovery, Emojis</em>.
        </section>
        <section>
          <strong>Import</strong><br/>
          ‚Ä¢ Click ‚ÄúImport from Excel (history file)‚Äù and select an .xlsx that was exported from this page.<br/>
          ‚Ä¢ All historical rows are loaded into memory.<br/>
          ‚Ä¢ Team is set from the last row, and the year/week selector is advanced one week compared to the last code (YYWW).<br/>
          ‚Ä¢ The team member list is created from the selected team, but current statuses and emojis are cleared
            so you can enter new values for the next week.<br/>
          ‚Ä¢ For each person you see the latest two weeks, with all four areas, in the history column.
        </section>
        <section>
          <strong>New week & export</strong><br/>
          ‚Ä¢ Make sure the Year and Week combination produces the YYWW code you want.<br/>
          ‚Ä¢ You cannot export if that week code already exists for this team in the history file.<br/>
          ‚Ä¢ Enter statuses and optional emojis per member.<br/>
          ‚Ä¢ ‚ÄúExport to Excel‚Äù writes a <em>Summary</em> sheet for the current week and a <em>Members</em> sheet
            with all history plus the new week added. Older weeks remain unchanged.<br/>
          ‚Ä¢ The downloaded file uses the same filename as the imported file, so you can overwrite it easily.
        </section>
      `
    };

    const areaData = {};
    const overall = { blue:0, green:0, yellow:0, red:0 };

    const members = []; // current week/team
    let historyRows = []; // all imported rows
    let lastImportedFilename = null; // used to export with the same name

    function openModal(html) {
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modalBackdrop").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modalBackdrop").style.display = "none";
    }

    function openUsageInfo() {
      openModal(`<h3>${usageInfo.title}</h3>${usageInfo.html}`);
    }
    function openMemberFileInfo() {
      openModal(`<h3>${memberFileInfo.title}</h3>${memberFileInfo.html}`);
    }

    function openAreaInfo(area) {
      const info = areaInfo[area];
      if (!info) return;
      const html = `
        <h3>${area}</h3>
        <section><strong>Definition:</strong><br/>${info.definition}</section>
        <section><strong>Reflection questions:</strong>
          <ul>${info.questions.map(q => `<li>${q}</li>`).join("")}</ul>
        </section>
        <section>
          <strong>Colour hints:</strong><br/>
          ‚Ä¢ üîµüü¢ ‚Äì keep and spread what works.<br/>
          ‚Ä¢ üü° ‚Äì follow up and agree on improvements.<br/>
          ‚Ä¢ üî¥ ‚Äì urgent: understand causes, act and consider escalation.
        </section>`;
      openModal(html);
    }

    function toggleMembersSection() {
      const checked = document.getElementById("toggleMembers").checked;
      document.getElementById("membersSection").style.display = checked ? "block" : "none";
    }

    function initAreas() {
      areas.forEach(a => areaData[a] = { blue:0, green:0, yellow:0, red:0 });
      areas.forEach(updateAreaCounts);
      updateOverlayAreas();
    }

    function increment(area, colour) {
      areaData[area][colour]++;
      overall[colour]++;
      updateAreaCounts(area);
      updateOverlayAreas();
    }

    function updateAreaCounts(area) {
      const el = document.getElementById("counts-" + area.replace(/\s/g,""));
      if (!el) return;
      const d = areaData[area];
      el.innerHTML =
        `<span><strong>B:</strong> ${d.blue}</span>` +
        `<span><strong>G:</strong> ${d.green}</span>` +
        `<span><strong>Y:</strong> ${d.yellow}</span>` +
        `<span><strong>R:</strong> ${d.red}</span>`;
    }

    function makeStatusIcons(d) {
      const icons = [];
      if (d.blue  > 0) icons.push("üîµ".repeat(Math.min(d.blue,10))   + (d.blue  >10?"+":""));
      if (d.green > 0) icons.push("üü¢".repeat(Math.min(d.green,10))  + (d.green >10?"+":""));
      if (d.yellow> 0) icons.push("üü°".repeat(Math.min(d.yellow,10)) + (d.yellow>10?"+":""));
      if (d.red   > 0) icons.push("üî¥".repeat(Math.min(d.red,10))    + (d.red   >10?"+":""));
      if (!icons.length) return '<span style="font-size:11px;color:#666;">‚Äì</span>';
      return icons.map(r => `<span>${r}</span>`).join("");
    }

    function updateOverlayAreas() {
      areas.forEach(area => {
        const overlay = document.getElementById("overlay-" + area);
        if (!overlay) return;
        const iconsDiv = overlay.querySelector(".overlay-icons");
        iconsDiv.innerHTML = makeStatusIcons(areaData[area]);
      });
    }

    function addMember() {
      const nameInput = document.getElementById("memberNameInput");
      const name = nameInput.value.trim();
      if (!name) return;
      members.push({
        name,
        ratings: {},
        emojis: { gratitude:false, heart:false, thumb:false }
      });
      nameInput.value = "";
      renderMembersTable();
      recalcFromMembers();
    }

    function removeMember(index) {
      members.splice(index,1);
      renderMembersTable();
      recalcFromMembers();
    }

    function emojiSetString(emojis) {
      let s = "";
      if (emojis.gratitude) s += "üôè";
      if (emojis.heart)     s += "‚ù§Ô∏è";
      if (emojis.thumb)     s += "üëç";
      return s;
    }

    function renderMembersTable() {
      const tbody = document.querySelector("#membersTable tbody");
      tbody.innerHTML = "";
      const team = document.getElementById("teamInput").value.trim();

      members.forEach((m, idx) => {
        const tr = document.createElement("tr");

        // name
        const nameTd = document.createElement("td");
        nameTd.textContent = m.name;
        tr.appendChild(nameTd);

        // status dropdowns (üîµüü¢üü°üî¥)
        areas.forEach(area => {
          const td = document.createElement("td");
          const sel = document.createElement("select");
          sel.style.fontSize = "14px";
          sel.style.textAlign = "center";
          const options = [
            { value:"",   label:""   },
            { value:"blue",   label:"üîµ" },
            { value:"green",  label:"üü¢" },
            { value:"yellow", label:"üü°" },
            { value:"red",    label:"üî¥" }
          ];
          options.forEach(o => {
            const opt = document.createElement("option");
            opt.value = o.value;
            opt.textContent = o.label;
            if ((m.ratings[area] || "") === o.value) opt.selected = true;
            sel.appendChild(opt);
          });
          sel.addEventListener("change", () => {
            m.ratings[area] = sel.value;
            recalcFromMembers();
          });
          td.appendChild(sel);
          tr.appendChild(td);
        });

        // emojis ‚Äì three toggles: gratitude, heart, thumb
        const emojisTd = document.createElement("td");
        const wrapper = document.createElement("div");
        wrapper.className = "emoji-toggles";

        const makeToggle = (key, symbol, title) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "emoji-toggle" + (m.emojis[key] ? " active" : "");
          btn.textContent = symbol;
          btn.title = title;
          btn.addEventListener("click", () => {
            m.emojis[key] = !m.emojis[key];
            if (m.emojis[key]) btn.classList.add("active");
            else btn.classList.remove("active");
          });
          return btn;
        };

        wrapper.appendChild(makeToggle("gratitude","üôè","Gratitude / thanks"));
        wrapper.appendChild(makeToggle("heart","‚ù§Ô∏è","Care / support"));
        wrapper.appendChild(makeToggle("thumb","üëç","Thumbs up / well done"));

        emojisTd.appendChild(wrapper);
        tr.appendChild(emojisTd);

        // recent 2 weeks horizontally
        const prevTd = document.createElement("td");
        prevTd.className = "prev-week-cell";
        prevTd.innerHTML = buildRecentTwoWeeksStatus(m.name, team);
        tr.appendChild(prevTd);

        // remove
        const removeTd = document.createElement("td");
        const rm = document.createElement("button");
        rm.className = "remove-btn";
        rm.textContent = "X";
        rm.title = "Remove member";
        rm.onclick = () => removeMember(idx);
        removeTd.appendChild(rm);
        tr.appendChild(removeTd);

        tbody.appendChild(tr);
      });
    }

    function mapDot(c) {
      c = (c || "").toLowerCase();
      if (c === "blue") return "üîµ";
      if (c === "green") return "üü¢";
      if (c === "yellow") return "üü°";
      if (c === "red") return "üî¥";
      return "‚ö™";
    }

    // 2 senaste veckorna per person, horisontellt
    function buildRecentTwoWeeksStatus(name, team) {
      if (!historyRows.length) return "";
      const rows = historyRows.filter(r => r.Member === name && r.Team === team);
      if (!rows.length) return "";

      const seenWeeks = new Set();
      const picked = [];

      for (let i = rows.length - 1; i >= 0; i--) {
        const r = rows[i];
        const w = r.Week || "?";
        if (!seenWeeks.has(w)) {
          seenWeeks.add(w);
          picked.push(r);
          if (picked.length === 2) break;
        }
      }

      picked.reverse(); // √§ldst av de 2 f√∂rst

      return picked.map(r => {
        const w = r.Week || "?";
        return `
          <span class="prev-week-chip">
            <strong>${w}</strong>
            M:${mapDot(r.Manageability)}
            C:${mapDot(r.Comprehensibility)}
            Me:${mapDot(r.Meaningfulness)}
            R:${mapDot(r.Recovery)}
          </span>
        `;
      }).join("");
    }

    function recalcFromMembers() {
      // reset
      areas.forEach(a => areaData[a] = { blue:0, green:0, yellow:0, red:0 });
      overall.blue = overall.green = overall.yellow = overall.red = 0;

      members.forEach(m => {
        areas.forEach(a => {
          const c = (m.ratings[a] || "").toLowerCase();
          if (c && areaData[a][c] !== undefined) {
            areaData[a][c]++;
            overall[c]++;
          }
        });
      });

      areas.forEach(updateAreaCounts);
      updateOverlayAreas();
    }

    /* ---------- WEEK SELECTORS (YYWW) ---------- */

    function initYearWeekSelectors() {
      const yearSelect = document.getElementById("yearSelect");
      const weekSelect = document.getElementById("weekSelect");

      const now = new Date();
      const currentYear = now.getFullYear();

      // years: current year -1, current, +1
      [currentYear - 1, currentYear, currentYear + 1].forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      });

      // weeks 1..53
      for (let w = 1; w <= 53; w++) {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w.toString().padStart(2, "0");
        weekSelect.appendChild(opt);
      }

      weekSelect.value = getISOWeek(now); // start on current ISO week
      updateWeekCodeDisplay();

      yearSelect.addEventListener("change", updateWeekCodeDisplay);
      weekSelect.addEventListener("change", updateWeekCodeDisplay);
    }

    function getYearWeekCode() {
      const year = parseInt(document.getElementById("yearSelect").value, 10);
      const week = parseInt(document.getElementById("weekSelect").value, 10);
      if (!year || !week) return "";
      const yy = (year % 100).toString().padStart(2,"0");
      const ww = week.toString().padStart(2,"0");
      return yy + ww;
    }

    function updateWeekCodeDisplay() {
      document.getElementById("weekCodeDisplay").value = getYearWeekCode();
    }

    // simple ISO week of date
    function getISOWeek(date) {
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
      const week = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
      return week;
    }

    function setYearWeekFromCode(code) {
      // code format: YYWW
      if (!/^\d{4}$/.test(code)) return;
      const yy = parseInt(code.slice(0,2),10);
      const ww = parseInt(code.slice(2,4),10);
      const year = 2000 + yy; // simple mapping
      const yearSelect = document.getElementById("yearSelect");
      const weekSelect = document.getElementById("weekSelect");

      // if year not in list, add it
      if (![...yearSelect.options].some(o => parseInt(o.value,10) === year)) {
        const opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year;
        yearSelect.appendChild(opt);
      }
      yearSelect.value = year;
      weekSelect.value = ww;
      updateWeekCodeDisplay();
    }

    function incrementWeekCode(code) {
      if (!/^\d{4}$/.test(code)) return code;
      let yy = parseInt(code.slice(0,2),10);
      let ww = parseInt(code.slice(2,4),10);
      ww += 1;
      if (ww > 53) {
        ww = 1;
        yy += 1;
        if (yy > 99) yy = 0;
      }
      const yyStr = yy.toString().padStart(2,"0");
      const wwStr = ww.toString().padStart(2,"0");
      return yyStr + wwStr;
    }

    /* ---------- IMPORT XLSX HISTORY ---------- */

    function handleMemberFileImport(file) {
      if (!file) return;
      lastImportedFilename = file.name || null;

      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const sheet = wb.Sheets["Members"] || wb.Sheets[wb.SheetNames[0]];
        if (!sheet) {
          alert("No sheet named 'Members' or first sheet found in the file.");
          return;
        }
        historyRows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
        if (!historyRows.length) {
          alert("The Members sheet is empty.");
          return;
        }

        const last = historyRows[historyRows.length - 1];
        const lastTeam = last.Team || "";
        const lastWeekCode = (last.Week || "").toString();

        document.getElementById("teamInput").value = lastTeam;

        // om senaste veckan ser ut som YYWW ‚Üí √∂ka med 1
        if (/^\d{4}$/.test(lastWeekCode)) {
          const nextCode = incrementWeekCode(lastWeekCode);
          setYearWeekFromCode(nextCode);
        } else {
          // annars l√•t selektorerna vara som de redan √§r, men uppdatera display
          updateWeekCodeDisplay();
        }

        // Build member list for this team from history, CLEAR ratings/emojis
        const latestByName = {};
        historyRows.forEach(r => {
          if (!r.Member || r.Team !== lastTeam) return;
          latestByName[r.Member] = r; // last wins per member
        });

        members.length = 0;
        Object.keys(latestByName).forEach(name => {
          members.push({
            name,
            ratings: {}, // reset for new week
            emojis: { gratitude:false, heart:false, thumb:false } // reset
          });
        });

        document.getElementById("toggleMembers").checked = true;
        document.getElementById("membersSection").style.display = "block";

        renderMembersTable();
        // reset the circle when importing (no new input yet)
        areas.forEach(a => areaData[a] = { blue:0, green:0, yellow:0, red:0 });
        overall.blue = overall.green = overall.yellow = overall.red = 0;
        areas.forEach(updateAreaCounts);
        updateOverlayAreas();

        alert("History imported. Team members loaded and statuses cleared. Week has been advanced by one step (YYWW).");
      };
      reader.readAsArrayBuffer(file);
    }

    /* ---------- EXPORT XLSX ---------- */

    function exportToExcel() {
      const team = document.getElementById("teamInput").value.trim();
      const weekCode = getYearWeekCode();

      if (!team) {
        alert("Please enter a team name before exporting.");
        return;
      }
      if (!weekCode || !/^\d{4}$/.test(weekCode)) {
        alert("Please select a valid year and week so that a YYWW code can be created.");
        return;
      }

      // Enforce that this week does not already exist for this team in history
      const exists = historyRows.some(r => (r.Team || "") === team && (r.Week || "") === weekCode);
      if (exists) {
        alert("This week code (YYWW) already exists for this team in the history file. Please choose a new week so history can grow.");
        return;
      }

      const wb = XLSX.utils.book_new();

      // Summary sheet
      const summaryData = [
        ["Workbalance ‚Äì TRATON"],
        [],
        ["Team", team],
        ["Week (YYWW)", weekCode],
        [],
        ["Area","Blue (excellent)","Green (good)","Yellow (insufficient)","Red (poor)"]
      ];
      areas.forEach(a => {
        const d = areaData[a];
        summaryData.push([a, d.blue, d.green, d.yellow, d.red]);
      });
      summaryData.push(["Total", overall.blue, overall.green, overall.yellow, overall.red]);
      const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

      // Members sheet
      const header = ["Week","Team","Member","Manageability","Comprehensibility","Meaningfulness","Recovery","Emojis"];
      const rows = [header];

      // keep old rows
      (historyRows || []).forEach(r => {
        rows.push([
          r.Week || "",
          r.Team || "",
          r.Member || "",
          r.Manageability || "",
          r.Comprehensibility || "",
          r.Meaningfulness || "",
          r.Recovery || "",
          r.Emojis || ""
        ]);
      });

      // add current week rows
      members.forEach(m => {
        rows.push([
          weekCode,
          team,
          m.name,
          m.ratings["Manageability"] || "",
          m.ratings["Comprehensibility"] || "",
          m.ratings["Meaningfulness"] || "",
          m.ratings["Recovery"] || "",
          emojiSetString(m.emojis)
        ]);
      });

      const wsMembers = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, wsMembers, "Members");

      // update in-memory history for next time
      historyRows = XLSX.utils.sheet_to_json(wsMembers, { defval: "" });

      // filnamn ‚Äì anv√§nd importerat om det finns, annars team_workbalance
      let fileName;
      if (lastImportedFilename) {
        fileName = lastImportedFilename;
      } else {
        const safeTeam = team.replace(/\s+/g,"_");
        fileName = (safeTeam || "team") + "_workbalance.xlsx";
      }

      XLSX.writeFile(wb, fileName);
    }

    /* --------- INIT --------- */
    window.addEventListener("DOMContentLoaded", () => {
      initAreas();
      initYearWeekSelectors();
    });
  </script>
</body>
</html>
