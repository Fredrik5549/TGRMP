<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Workbalance ‚Äì TRATON (fixed)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- ExcelJS for export (dataValidation support), FileSaver for download -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<!-- SheetJS for import (robust parsing) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- confetti for celebration -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  /* (kept most of your styles, slightly trimmed) */
  body{font-family:Arial, sans-serif;background:#f4f5f7 url("PMO_mission.png") center/cover fixed no-repeat;margin:0;padding:20px;color:#12213b}
  .page-shell{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.92);border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.18);padding:18px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:8px;flex-wrap:wrap}
  .logo-wrapper img{height:40px}
  h1{margin:0;font-size:28px}
  .traton-label{font-size:12px;color:#555;margin-top:2px;letter-spacing:2px;text-transform:uppercase}
  .intro-block{margin:8px 0 6px 0;max-width:900px;font-size:14px}
  .helper-link{font-size:13px;color:#1a73e8;text-decoration:underline;cursor:pointer}
  .circle-layout{display:flex;justify-content:center;margin-top:10px;margin-bottom:10px}
  .circle-layout-inner{position:relative;max-width:820px;width:100%;min-height:420px;margin:0 auto}
  .circle-wrapper{position:absolute;top:42%;left:50%;transform:translate(-50%,-50%);display:inline-block}
  .circle-wrapper img{max-width:560px;width:100%;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.16);display:block}
  .area-overlay-box{position:absolute;background:rgba(255,255,255,0.95);border-radius:10px;padding:4px 6px;font-size:14px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.18);min-width:80px;min-height:28px;display:flex;align-items:center;justify-content:center;line-height:1.2}
  #overlay-Manageability{top:12%;left:12%}
  #overlay-Comprehensibility{top:12%;right:12%}
  #overlay-Meaningfulness{bottom:12%;left:12%}
  #overlay-Recovery{bottom:12%;right:12%}
  .area-card{position:absolute;width:190px;background:#fff;border-radius:10px;padding:6px 8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);font-size:11px}
  .area-title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .area-title{font-weight:bold;font-size:12px}
  .info-link{font-size:10px;text-decoration:underline;color:#1a73e8;cursor:pointer}
  .buttons-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:2px}
  .color-btn{border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:11px;color:#fff}
  .blue{background:#2b6cb0}.green{background:#38a169}.yellow{background:#ecc94b;color:#000}.red{background:#e53e3e}
  .counts{display:none}
  #card-Manageability{top:-10px;left:-4%}
  #card-Comprehensibility{top:-10px;right:-4%}
  #card-Meaningfulness{bottom:40px;left:-4%}
  #card-Recovery{bottom:40px;right:-4%}
  .workload-avg-box{position:absolute;top:50%;right:-10%;transform:translateY(-50%);background:rgba(255,255,255,0.95);border-radius:10px;padding:6px 8px;box-shadow:0 1px 4px rgba(0,0,0,0.18);text-align:center;font-size:11px;width:82px}
  .workload-bar-outer{height:80px;width:18px;margin:6px auto;border-radius:8px;border:1px solid #ccc;background:linear-gradient(to top,#f44336,#ffeb3b,#4caf50);position:relative;overflow:hidden}
  .workload-bar-inner{position:absolute;bottom:0;left:0;right:0;background:rgba(18,33,59,0.9);height:0%;border-radius:8px 8px 0 0;transition:height .25s}
  .workload-value{margin-top:2px;font-size:11px}
  .fun-row{margin-top:16px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .fun-row button{padding:6px 10px;border-radius:16px;border:none;cursor:pointer;font-size:13px;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.18);display:flex;align-items:center;gap:6px}
  .fun-celebrate{background:linear-gradient(135deg,#ff9800,#f44336)}.fun-hug{background:linear-gradient(135deg,#e91e63,#ff80ab)}.fun-truck{background:linear-gradient(135deg,#1565c0,#26c6da)}.fun-leader{background:linear-gradient(135deg,#4caf50,#8bc34a)}
  .members-section{margin-top:10px;padding:10px 12px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:none}
  .members-table-container{max-height:180px;overflow:auto;margin-top:4px}
  table.members-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:4px}
  table.members-table th,table.members-table td{border:1px solid #ccc;padding:2px 4px;text-align:center;line-height:1.2}
  table.members-table th{background:#12213b;color:#fff;position:sticky;top:0;z-index:1;font-size:11px;padding:2px 4px}
  .remove-btn{border:none;background:#e53e3e;color:#fff;border-radius:3px;padding:1px 4px;cursor:pointer;font-size:10px}
  .prev-week-cell{font-size:10px;line-height:1.2;white-space:nowrap}
  .prev-week-chip{display:inline-block;margin-right:8px}
  .history-circles{margin-top:20px;display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
  .bottom-meta{margin-top:12px;padding:10px 12px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;font-size:13px}
  .meta-fields{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .meta-group{display:flex;flex-direction:column;gap:2px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{background:#fff;max-width:650px;max-height:80vh;overflow-y:auto;border-radius:10px;padding:18px 20px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
  .modal-close{float:right;cursor:pointer;font-weight:bold;font-size:18px}
  @media(max-width:800px){body{padding:8px}.page-shell{padding:14px}header{flex-direction:column;align-items:flex-start}.circle-wrapper{position:static;transform:none;display:flex;justify-content:center;margin-bottom:10px}.area-overlay-box{display:none}.workload-avg-box{position:static;margin:4px auto 0 auto}.bottom-meta{flex-direction:column;align-items:flex-start}.members-table-container{max-height:220px}}
</style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="logo-wrapper"><img src="Traton_logo.png" alt="TRATON Group logo"></div>
      <div>
        <h1>Workbalance</h1>
        <div class="traton-label">TRATON GROUP ‚Äì WORK BALANCE DIALOGUE</div>
      </div>
    </header>

    <div class="intro-block">
      <div class="intro-text">
        Workbalance supports team dialogue about sustainable work. Rate four areas (Manageability, Comprehensibility, Meaningfulness, Recovery) using colours blue / green / yellow / red. Use the member view for per-person inputs. Export includes history and a circle snapshot.
      </div>
      <div><span class="helper-link" onclick="openUsageInfo()">How do we use this page?</span></div>
    </div>

    <div class="circle-layout">
      <div class="circle-layout-inner">
        <div class="circle-wrapper">
          <canvas id="circleCanvas" width="560" height="560" style="border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.16);background:white"></canvas>

          <div class="area-overlay-box" id="overlay-Manageability"></div>
          <div class="area-overlay-box" id="overlay-Comprehensibility"></div>
          <div class="area-overlay-box" id="overlay-Meaningfulness"></div>
          <div class="area-overlay-box" id="overlay-Recovery"></div>

          <div class="workload-avg-box" id="workloadAvgBox">
            <div style="font-weight:bold;font-size:12px">Workload</div>
            <div class="workload-bar-outer"><div class="workload-bar-inner" id="workloadBarInner"></div></div>
            <div class="workload-value" id="workloadAvgValue">‚Äì</div>
          </div>
        </div>

        <div class="area-card" id="card-Manageability">
          <div class="area-title-row"><div class="area-title">Manageability</div><span class="info-link" onclick="openAreaInfo('Manageability')">What does this mean?</span></div>
          <div class="buttons-row">
            <button class="color-btn blue" onclick="increment('Manageability','blue')">Blue +1</button>
            <button class="color-btn green" onclick="increment('Manageability','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Manageability','yellow')">Yellow +1</button>
            <button class="color-btn red" onclick="increment('Manageability','red')">Red +1</button>
          </div>
        </div>

        <div class="area-card" id="card-Comprehensibility">
          <div class="area-title-row"><div class="area-title">Comprehensibility</div><span class="info-link" onclick="openAreaInfo('Comprehensibility')">What does this mean?</span></div>
          <div class="buttons-row">
            <button class="color-btn blue" onclick="increment('Comprehensibility','blue')">Blue +1</button>
            <button class="color-btn green" onclick="increment('Comprehensibility','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Comprehensibility','yellow')">Yellow +1</button>
            <button class="color-btn red" onclick="increment('Comprehensibility','red')">Red +1</button>
          </div>
        </div>

        <div class="area-card" id="card-Meaningfulness">
          <div class="area-title-row"><div class="area-title">Meaningfulness</div><span class="info-link" onclick="openAreaInfo('Meaningfulness')">What does this mean?</span></div>
          <div class="buttons-row">
            <button class="color-btn blue" onclick="increment('Meaningfulness','blue')">Blue +1</button>
            <button class="color-btn green" onclick="increment('Meaningfulness','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Meaningfulness','yellow')">Yellow +1</button>
            <button class="color-btn red" onclick="increment('Meaningfulness','red')">Red +1</button>
          </div>
        </div>

        <div class="area-card" id="card-Recovery">
          <div class="area-title-row"><div class="area-title">Recovery</div><span class="info-link" onclick="openAreaInfo('Recovery')">What does this mean?</span></div>
          <div class="buttons-row">
            <button class="color-btn blue" onclick="increment('Recovery','blue')">Blue +1</button>
            <button class="color-btn green" onclick="increment('Recovery','green')">Green +1</button>
            <button class="color-btn yellow" onclick="increment('Recovery','yellow')">Yellow +1</button>
            <button class="color-btn red" onclick="increment('Recovery','red')">Red +1</button>
          </div>
        </div>
      </div>
    </div>

    <div class="fun-row">
      <button class="fun-celebrate" onclick="runCelebration()">üéâ Celebrate</button>
      <button class="fun-hug" onclick="runWarmHug()">ü§ó Warm hug</button>
      <button class="fun-truck" onclick="runTruckBoost()">üöö Truck boost</button>
      <button class="fun-leader" onclick="runLeaderBoost()">üßë‚Äçüíº Leader boost</button>
    </div>

    <div class="members-section" id="membersSection">
      <h2>Team member view (optional)</h2>
      <p>Enter one row per team member for the selected week and team. The history column shows the latest two weeks per person (horizontally).</p>
      <div class="workload-desc">Perceived workload (1=need more, 4=fully loaded). Average shows on the circle.</div>

      <div class="members-table-container">
        <table class="members-table" id="membersTable">
          <thead>
            <tr>
              <th>Member</th>
              <th>Manageability</th>
              <th>Comprehensibility</th>
              <th>Meaningfulness</th>
              <th>Recovery</th>
              <th>Workload<br/>(1‚Äì4)</th>
              <th>Recent weeks<br/>(2 latest)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="memberNameInput" type="text" placeholder="Team member name" />
        <button onclick="addMember()">Add member</button>
      </div>
    </div>

    <div id="historyCirclesContainer" class="history-circles"></div>

    <div style="margin-top:10px">
      <label><input type="checkbox" id="toggleMembers" onchange="toggleMembersSection()" /> Add status per team member (optional ‚Äì with weekly history)</label>
    </div>

    <div style="margin-top:10px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div>
        <button onclick="triggerGlobalImport()">Import from Excel (history file)</button>
        <input id="globalMemberFileInput" type="file" accept=".xlsx" style="display:none" onchange="handleGlobalImportFile(this.files[0])" />
      </div>
      <div style="margin-left:auto"></div>
    </div>

    <div class="bottom-meta">
      <div class="meta-fields">
        <div class="meta-group"><label for="teamInput">Team name</label><input id="teamInput" type="text" placeholder="e.g. XTRM Platform" /></div>
        <div class="meta-group"><label>Year / Week (YYWW)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="yearSelect"></select>
            <select id="weekSelect"></select>
            <input id="weekCodeDisplay" readonly style="background:#f3f3f3;padding:4px 6px" />
          </div>
        </div>
        <div class="meta-group"><label>Export filename (optional)</label><input id="exportFileName" type="text" placeholder="team_workbalance.xlsx" /></div>
      </div>

      <div class="export-container">
        <button onclick="exportToExcel()">Export to Excel</button>
      </div>
    </div>

  </div>

  <div class="modal-backdrop" id="modalBackdrop"><div class="modal" id="modal"><span class="modal-close" onclick="closeModal()">&times;</span><div id="modalContent"></div></div></div>

<script>
/* ========= Data & config ========= */
const AREAS = ["Manageability","Comprehensibility","Meaningfulness","Recovery"];
const COLORS = { blue:"#0b3b66", green:"#0f9d58", yellow:"#f0ad4e", red:"#d64545" };
let areaData = {}, overall = {blue:0,green:0,yellow:0,red:0};
let members = []; // {name, ratings:{area:color}, workload:int}
let historyRows = []; // imported full history (array of objects)
let lastImportedFilename = null;

/* ======= UI helpers (modal) ======= */
function openModal(html){ document.getElementById("modalContent").innerHTML = html; document.getElementById("modalBackdrop").style.display = "flex"; }
function closeModal(){ document.getElementById("modalBackdrop").style.display = "none"; }

/* ======= Info texts (kept from your original) ======= */
function openUsageInfo(){ openModal(`<h3>How to use this page</h3><p>Use import to load history, select team & week, fill statuses and export. The exported file contains Members, Summary and CircleSnapshot sheets. The Members sheet contains data validation (dropdown) for statuses.</p>`); }
function openAreaInfo(area){
  // short info (same as before)
  const defs = {
    Manageability: "Balance between demands & resources‚Ä¶",
    Comprehensibility: "Understanding of organisation & roles‚Ä¶",
    Meaningfulness: "Feeling of value & inclusion‚Ä¶",
    Recovery: "Ability to rest and recharge‚Ä¶"
  };
  openModal(`<h3>${area}</h3><p>${defs[area]}</p>`);
}

/* ======= Init ======= */
function initAreas(){ AREAS.forEach(a=>areaData[a]={blue:0,green:0,yellow:0,red:0}); updateAllDisplays(); }
function updateAllDisplays(){ renderMembersTable(); updateOverlayAreas(); updateWorkloadOverlay(); renderHistoryCirclesForTeam(document.getElementById('teamInput').value.trim()); }

/* ======= Canvas circle & overlay rendering ======= */
const canvas = document.getElementById('circleCanvas');
const ctx = canvas.getContext('2d');
let circleImg = new Image();
circleImg.crossOrigin = "anonymous";
circleImg.onload = ()=> drawCircle();
circleImg.onerror = ()=> drawPlaceholder();
circleImg.src = "workbalance_circle.png";

function drawPlaceholder(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#12213b"; ctx.beginPath(); ctx.arc(canvas.width/2,canvas.height/2,200,0,Math.PI*2); ctx.fill();
}

function drawCircle(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const cw=canvas.width,ch=canvas.height,iw=circleImg.naturalWidth,ih=circleImg.naturalHeight;
  const scale=Math.min(cw/iw,ch/ih)*0.98; const iw2=iw*scale,ih2=ih*scale;
  ctx.drawImage(circleImg,(cw-iw2)/2,(ch-ih2)/2,iw2,ih2);
  // overlay dots
  drawOverlayDots();
}

function drawOverlayDots(){
  // compute counts from members for currently selected week (we treat members array as current-week)
  const counts = {};
  AREAS.forEach(a=>counts[a]={blue:0,green:0,yellow:0,red:0});
  members.forEach(m=>{
    AREAS.forEach(a=>{
      const c=(m.ratings[a]||"").toLowerCase();
      if(c && counts[a][c]!==undefined) counts[a][c]++;
    });
  });
  // positions near quadrants
  const center={x:canvas.width/2,y:canvas.height/2};
  const pos = {
    Manageability:{x:center.x-120,y:center.y-120},
    Comprehensibility:{x:center.x+120,y:center.y-120},
    Meaningfulness:{x:center.x-120,y:center.y+120},
    Recovery:{x:center.x+120,y:center.y+120}
  };
  // draw rows per color; break into new row after 5
  Object.keys(pos).forEach(area=>{
    const d=counts[area];
    let baseY = 0;
    ['blue','green','yellow','red'].forEach((color,ci)=>{
      const n=d[color]||0;
      for(let i=0;i<n;i++){
        const row=Math.floor(i/5), col=i%5;
        const spacing=14;
        const x=pos[area].x + col*(spacing+4);
        const y=pos[area].y + baseY + row*(spacing+4);
        ctx.beginPath(); ctx.fillStyle=COLORS[color]; ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();
      }
      baseY += 22;
    });
  });
}

/* ======= Area increment (team-level) ======= */
function increment(area, color){
  if(!areaData[area]) areaData[area]={blue:0,green:0,yellow:0,red:0};
  areaData[area][color] = (areaData[area][color]||0) + 1;
  // apply as synthetic team-level "member" named (Team overall) - easier to show dots and export
  const teamRowName="(Team overall)";
  let row = members.find(m=>m.name===teamRowName && !m.isSynthetic);
  if(!row){
    // create a synthetic member per area? simpler: push one pseudo-member with ratings aggregated (keeps member table compact)
    row = { name: teamRowName, ratings: {}, workload: null, isSynthetic: true };
    members.push(row);
  }
  // set the area's color as the last clicked color (affects overlay)
  row.ratings[area] = color;
  updateAllDisplays();
}

/* ======= Members table (no emojis per person) ======= */
function addMember(){
  const name = document.getElementById('memberNameInput').value.trim();
  if(!name) return alert('Enter a member name');
  members.push({ name, ratings:{}, workload:null });
  document.getElementById('memberNameInput').value='';
  renderMembersTable(); updateAllDisplays();
}

function removeMember(idx){ members.splice(idx,1); renderMembersTable(); updateAllDisplays(); }

function renderMembersTable(){
  const tbody = document.querySelector('#membersTable tbody');
  tbody.innerHTML='';
  const team = document.getElementById('teamInput').value.trim();
  members.forEach((m, idx)=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.textContent=m.name; tr.appendChild(tdName);
    AREAS.forEach(a=>{
      const td=document.createElement('td');
      const sel=document.createElement('select'); sel.style.fontSize='13px'; ['','blue','green','yellow','red'].forEach(v=>{
        const opt=document.createElement('option'); opt.value=v; opt.textContent = v? mapDot(v): '';
        if((m.ratings[a]||'')===v) opt.selected=true; sel.appendChild(opt);
      });
      sel.addEventListener('change', ()=>{ m.ratings[a]=sel.value; drawCircle(); updateWorkloadOverlay(); });
      td.appendChild(sel); tr.appendChild(td);
    });
    const tdWL=document.createElement('td');
    const wlSel=document.createElement('select'); ['','1','2','3','4'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(String(m.workload||'')===v) o.selected=true; wlSel.appendChild(o);});
    wlSel.addEventListener('change', ()=>{ m.workload = wlSel.value? parseInt(wlSel.value,10): null; updateWorkloadOverlay(); });
    tdWL.appendChild(wlSel); tr.appendChild(tdWL);

    const tdRecent=document.createElement('td'); tdRecent.className='prev-week-cell'; tdRecent.innerHTML = buildRecentTwoWeeksStatus(m.name, team); tr.appendChild(tdRecent);
    const tdRem=document.createElement('td'); const btn=document.createElement('button'); btn.className='remove-btn'; btn.textContent='X'; btn.onclick=()=>removeMember(idx); tdRem.appendChild(btn); tr.appendChild(tdRem);

    tbody.appendChild(tr);
  });
}

/* ======= Recent two weeks builder (from historyRows) ======= */
function buildRecentTwoWeeksStatus(name, team){
  if(!historyRows.length) return '';
  const rows = historyRows.filter(r => r.Member===name && r.Team===team);
  if(!rows.length) return '';
  const seen=new Set(); const picked=[];
  for(let i=rows.length-1;i>=0;i--){
    const r=rows[i]; const w=(r.Week||'').toString(); if(!w) continue; if(!seen.has(w)){ seen.add(w); picked.push(r); if(picked.length===2) break; }
  }
  picked.reverse();
  return picked.map(r=>{
    const w=(r.Week||'').toString();
    return `<span class="prev-week-chip"><strong>${w}</strong> M:${mapDot(r.Manageability)} C:${mapDot(r.Comprehensibility)} Me:${mapDot(r.Meaningfulness)} R:${mapDot(r.Recovery)}</span>`;
  }).join('');
}
function mapDot(c){ c=(c||'').toLowerCase(); if(c==='blue') return 'üîµ'; if(c==='green') return 'üü¢'; if(c==='yellow') return 'üü°'; if(c==='red') return 'üî¥'; return '‚ö™'; }

/* ======= Recalc from members -> areaData, overlay, workload ======= */
function recalcFromMembers(){
  areaData = {}; overall = {blue:0,green:0,yellow:0,red:0};
  AREAS.forEach(a=>areaData[a]={blue:0,green:0,yellow:0,red:0});
  members.forEach(m=>{
    AREAS.forEach(a=>{
      const c=(m.ratings[a]||'').toLowerCase();
      if(c && areaData[a] && areaData[a][c]!==undefined){ areaData[a][c]++; overall[c]++; }
    });
  });
  updateOverlayAreas(); updateWorkloadOverlay(); drawCircle();
}

function updateOverlayAreas(){
  // update small overlay boxes (HTML) as well as canvas
  AREAS.forEach(a=>{
    const el=document.getElementById('overlay-'+a);
    if(!el) return;
    const d = areaData[a] || {blue:0,green:0,yellow:0,red:0};
    el.innerHTML = makeStatusIcons(d);
  });
}

/* create icons with linebreak after 5 */
function makeStatusIcons(d){
  const total=(d.blue||0)+(d.green||0)+(d.yellow||0)+(d.red||0);
  if(!total) return '<span style="font-size:12px;color:#666">‚Äì</span>';
  const tokens=[];
  const add=(sym,cnt)=>{ for(let i=0;i<cnt;i++){ if(tokens.length<15) tokens.push(sym); } };
  add('üîµ', d.blue||0); add('üü¢', d.green||0); add('üü°', d.yellow||0); add('üî¥', d.red||0);
  let html=''; tokens.forEach((t,i)=>{ if(i>0 && i%5===0) html+='<br>'; html+=`<span>${t}</span>`; });
  const extra = total - tokens.length; if(extra>0) html+=`<span>+${extra}</span>`;
  return html;
}

/* ======= Workload overlay (avg) ======= */
function updateWorkloadOverlay(){
  const bar=document.getElementById('workloadBarInner'), val=document.getElementById('workloadAvgValue');
  let sum=0, count=0; members.forEach(m=>{ if(typeof m.workload==='number'){ sum+=m.workload; count++; }});
  if(!count){ bar.style.height='0%'; val.textContent='‚Äì'; return; }
  const avg=sum/count; const pct=Math.min(100,Math.max(0,(avg/4)*100));
  bar.style.height = pct + '%'; val.textContent = avg.toFixed(2) + ' / 4';
}

/* ======= Year/week selectors ======= */
function initYearWeekSelectors(){
  const yearSelect=document.getElementById('yearSelect'), weekSelect=document.getElementById('weekSelect');
  const now=new Date(), currentYear=now.getFullYear();
  [currentYear-1,currentYear,currentYear+1].forEach(y=>{ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; if(y===currentYear) opt.selected=true; yearSelect.appendChild(opt); });
  for(let w=1; w<=53; w++){ const opt=document.createElement('option'); opt.value=w; opt.textContent = String(w).padStart(2,'0'); weekSelect.appendChild(opt); }
  weekSelect.value = getISOWeek(now);
  updateWeekCodeDisplay();
  yearSelect.addEventListener('change', updateWeekCodeDisplay);
  weekSelect.addEventListener('change', updateWeekCodeDisplay);
}
function getISOWeek(date){ const tmp=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=tmp.getUTCDay()||7; tmp.setUTCDate(tmp.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(tmp.getUTCFullYear(),0,1)); return Math.ceil((((tmp-yearStart)/86400000)+1)/7); }
function getYearWeekCode(){ const y=document.getElementById('yearSelect').value, w=document.getElementById('weekSelect').value; if(!y||!w) return ''; const yy=(parseInt(y,10)%100).toString().padStart(2,'0'); return yy + String(w).padStart(2,'0'); }
function updateWeekCodeDisplay(){ document.getElementById('weekCodeDisplay').value = getYearWeekCode(); }
function incrementWeekCode(code){ if(!/^\d{4}$/.test(code)) return code; let yy=parseInt(code.slice(0,2),10), ww=parseInt(code.slice(2),10); ww++; if(ww>53){ ww=1; yy=(yy+1)%100; } return String(yy).padStart(2,'0') + String(ww).padStart(2,'0'); }
function setYearWeekFromCode(code){ if(!/^\d{4}$/.test(code)) return; const yy=parseInt(code.slice(0,2),10), ww=parseInt(code.slice(2),10); const year=2000+yy; const yearSelect=document.getElementById('yearSelect'), weekSelect=document.getElementById('weekSelect'); // ensure option exists
  if(![...yearSelect.options].some(o=>parseInt(o.value,10)===year)){ const opt=document.createElement('option'); opt.value=year; opt.textContent=year; yearSelect.appendChild(opt); }
  yearSelect.value=year; weekSelect.value=ww; updateWeekCodeDisplay();
}

/* ======= Import (SheetJS) - Members sheet expected ======= */
function triggerGlobalImport(){ document.getElementById('globalMemberFileInput').click(); }
function handleGlobalImportFile(file){ if(!file) return handleMemberFileImport(file); }

function handleMemberFileImport(file){
  if(!file) return;
  lastImportedFilename = file.name || null;
  const reader = new FileReader();
  reader.onload = e=>{
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data,{type:'array'});
    const sheet = wb.Sheets['Members'] || wb.Sheets[wb.SheetNames[0]];
    if(!sheet){ alert("No Members sheet found."); return; }
    historyRows = XLSX.utils.sheet_to_json(sheet, {defval:''});
    if(!historyRows.length){ alert("Members sheet empty."); return; }
    const last = historyRows[historyRows.length-1];
    const lastTeam = last.Team || '';
    const lastWeek = (last.Week||'').toString();
    document.getElementById('teamInput').value = lastTeam;
    if(/^\d{4}$/.test(lastWeek)){ const next = incrementWeekCode(lastWeek); setYearWeekFromCode(next); } else updateWeekCodeDisplay();
    // load only members present in latest week
    const latestByName = {};
    historyRows.forEach(r=>{ if(!r.Member) return; if(r.Team !== lastTeam) return; if((r.Week||'').toString() !== lastWeek) return; latestByName[r.Member]=r; });
    members = [];
    Object.keys(latestByName).forEach(name => members.push({ name, ratings:{}, workload: null }));
    document.getElementById('toggleMembers').checked = true; document.getElementById('membersSection').style.display='block';
    renderMembersTable(); recalcFromMembers(); renderHistoryCirclesForTeam(lastTeam);
    alert('Imported history. Members loaded from latest week; current-week statuses cleared. Week advanced.');
  };
  reader.readAsArrayBuffer(file);
}

/* ======= History circles rendering (bottom) ======= */
function renderHistoryCirclesForTeam(team){
  const container=document.getElementById('historyCirclesContainer'); container.innerHTML='';
  if(!team || !historyRows.length) return;
  const rows = historyRows.filter(r=> (r.Team||'')===team );
  if(!rows.length) return;
  const weekOrder=[]; rows.forEach(r=>{ const w=(r.Week||'').toString(); if(w && !weekOrder.includes(w)) weekOrder.push(w); });
  const selectedWeeks = weekOrder.slice(-4);
  const weekData = {};
  selectedWeeks.forEach(w=>{ weekData[w] = {}; AREAS.forEach(a=> weekData[w][a] = {blue:0,green:0,yellow:0,red:0}); });
  rows.forEach(r=>{ const w=(r.Week||'').toString(); if(!selectedWeeks.includes(w)) return; AREAS.forEach(a=>{ const val=(r[a]||'').toString().toLowerCase(); if(weekData[w][a][val]!==undefined) weekData[w][a][val]++; }); });
  selectedWeeks.forEach(w=>{
    const block=document.createElement('div'); block.className='history-circle-block';
    const lab=document.createElement('div'); lab.className='history-circle-week'; lab.textContent = w; block.appendChild(lab);
    const wrap=document.createElement('div'); wrap.className='history-circle-wrapper';
    const img=document.createElement('img'); img.src='workbalance_circle.png'; img.className='history-circle-img'; wrap.appendChild(img);
    AREAS.forEach((a,i)=>{ const ov=document.createElement('div'); ov.className='history-overlay ' + ['history-overlay-manage','history-overlay-comp','history-overlay-mean','history-overlay-recov'][i]; ov.innerHTML = makeStatusIcons(weekData[w][a]); wrap.appendChild(ov); });
    block.appendChild(wrap); container.appendChild(block);
  });
}

/* ======= Export (ExcelJS) with data validation and snapshot image ======= */
async function exportToExcel(){
  const team = document.getElementById('teamInput').value.trim();
  const weekCode = getYearWeekCode();
  if(!team){ alert('Please enter a team name'); return; }
  if(!/^\d{4}$/.test(weekCode)){ alert('Please select year & week (YYWW)'); return; }
  // check if exists
  const exists = (historyRows || []).some(r => (r.Team||'')===team && (r.Week||'')===weekCode);
  if(exists){ alert('Week code already exists for this team in history file. Choose a different week.'); return; }

  // Excel workbook via ExcelJS
  const wb = new ExcelJS.Workbook();
  wb.creator = 'Workbalance tool';
  wb.created = new Date();

  // Lists sheet for validation
  const lists = wb.addWorksheet('Lists');
  lists.getCell('A1').value = 'blue'; lists.getCell('A2').value='green'; lists.getCell('A3').value='yellow'; lists.getCell('A4').value='red';

  // Summary sheet (simple)
  const wsSummary = wb.addWorksheet('Summary');
  wsSummary.addRow(['Workbalance ‚Äì TRATON']); wsSummary.addRow([]);
  wsSummary.addRow(['Team', team]); wsSummary.addRow(['Week (YYWW)', weekCode]); wsSummary.addRow([]);
  wsSummary.addRow(['Area','Blue','Green','Yellow','Red']);
  AREAS.forEach(a=>{
    const d = areaData[a] || {blue:0,green:0,yellow:0,red:0};
    wsSummary.addRow([a, d.blue, d.green, d.yellow, d.red]);
  });
  wsSummary.addRow(['Total', overall.blue, overall.green, overall.yellow, overall.red]);

  // CircleSnapshot sheet: we will add image from canvas
  const snapSheet = wb.addWorksheet('CircleSnapshot');
  // draw snapshot from canvas
  const dataUrl = document.getElementById('circleCanvas').toDataURL('image/png');
  // add image (exceljs expects base64 without header)
  const base64 = dataUrl.split(',')[1];
  const imageId = wb.addImage({ base64: base64, extension: 'png' });
  snapSheet.addImage(imageId, { tl: { col: 0.2, row: 0.5 }, ext: { width: 720, height: 720 } });
  snapSheet.getCell('H2').value = 'Areas explanation';
  snapSheet.getCell('H3').value = 'Manageability: Balance of resources & demands';
  snapSheet.getCell('H4').value = 'Comprehensibility: Coherence & clarity';
  snapSheet.getCell('H5').value = 'Meaningfulness: Appreciation & involvement';
  snapSheet.getCell('H6').value = 'Recovery: Ability to rest & recover';
  snapSheet.getCell('H8').value = 'Legend';
  snapSheet.getCell('H9').value = 'blue = very good';
  snapSheet.getCell('H10').value = 'green = good';
  snapSheet.getCell('H11').value = 'yellow = watch';
  snapSheet.getCell('H12').value = 'red = critical';

  // Members sheet: include all historyRows plus current members as new rows
  const membersSheet = wb.addWorksheet('Members');
  const header = ["Week","Team","Member","Manageability","Comprehensibility","Meaningfulness","Recovery","Workload"];
  membersSheet.addRow(header);

  // push existing history rows first
  (historyRows || []).forEach(r=>{
    membersSheet.addRow([ r.Week||'', r.Team||'', r.Member||'', r.Manageability||'', r.Comprehensibility||'', r.Meaningfulness||'', r.Recovery||'', r.Workload||'' ]);
  });

  // add current members as new rows (weekCode)
  members.forEach(m=>{
    membersSheet.addRow([ weekCode, team, m.name, m.ratings['Manageability']||'', m.ratings['Comprehensibility']||'', m.ratings['Meaningfulness']||'', m.ratings['Recovery']||'', m.workload!=null?m.workload:'' ]);
  });

  // Data validation: for the 4 area columns (D,E,F,G) starting at row 2 -> use lists!$A$1:$A$4
  const lastRow = membersSheet.rowCount;
  for(let r=2;r<=lastRow;r++){
    for(let c=4;c<=7;c++){ // D..G
      const cell = membersSheet.getCell(r,c);
      cell.dataValidation = {
        type: 'list',
        allowBlank: true,
        showInputMessage: true,
        formulae: ['=Lists!$A$1:$A$4']
      };
    }
  }

  // Prepare filename
  let fileName = document.getElementById('exportFileName').value.trim();
  if(!fileName) {
    if(lastImportedFilename) fileName = lastImportedFilename;
    else fileName = (team.replace(/\s+/g,'_')||'team') + '_workbalance.xlsx';
  }
  if(!fileName.toLowerCase().endsWith('.xlsx')) fileName += '.xlsx';

  // write & save
  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
  saveAs(blob, fileName);

  // update historyRows in memory so next import/export uses same file behaviour
  // regenerate historyRows from membersSheet
  const wsOut = membersSheet;
  const json = [];
  for(let r=2;r<=membersSheet.rowCount;r++){
    const row = membersSheet.getRow(r).values.slice(1);
    json.push({
      Week: row[0]||'',
      Team: row[1]||'',
      Member: row[2]||'',
      Manageability: row[3]||'',
      Comprehensibility: row[4]||'',
      Meaningfulness: row[5]||'',
      Recovery: row[6]||'',
      Workload: row[7]||''
    });
  }
  historyRows = json;
  lastImportedFilename = fileName;
  alert('Exported ' + fileName);
}

/* ======= Celebration & fun ======= */
function runCelebration(){ if(typeof confetti !== 'undefined') { const end=Date.now()+2000; (function frame(){ confetti({particleCount:10,spread:70,origin:{y:0.6}}); if(Date.now()<end) requestAnimationFrame(frame); })(); } }
function spawnEmojiRain(set,duration=3800,count=40){ const overlay=document.createElement('div'); overlay.className='emoji-overlay'; document.body.appendChild(overlay); for(let i=0;i<count;i++){ const span=document.createElement('span'); span.className='emoji-float'; span.textContent=set[Math.floor(Math.random()*set.length)]; span.style.left=(Math.random()*100)+'%'; span.style.fontSize=(24+Math.random()*18)+'px'; span.style.animationDelay=(Math.random()*0.7)+'s'; overlay.appendChild(span); } setTimeout(()=>{ if(overlay.parentNode) overlay.parentNode.removeChild(overlay); }, duration); }
function runWarmHug(){ spawnEmojiRain(["ü§ó","‚ù§Ô∏è","‚ú®","ü§ù"],3800,40); }
function runTruckBoost(){ spawnEmojiRain(["üöö","üöõ","üõ£Ô∏è","‚≠ê"],3800,40); }
function runLeaderBoost(){ spawnEmojiRain(["üßë‚Äçüíº","üìà","üöÄ","üèÜ"],3800,40); }

/* ======= Helpers & init ======= */
function toggleMembersSection(){ const checked=document.getElementById('toggleMembers').checked; document.getElementById('membersSection').style.display = checked? 'block':'none'; }
function updateOverlayAreas(){ recalcFromMembers(); } // recalc draws
window.addEventListener('DOMContentLoaded', ()=>{ initAreas(); initYearWeekSelectors(); });

</script>
</body>
</html>
