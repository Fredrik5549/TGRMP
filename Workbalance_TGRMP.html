<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Workbalance - TRATON (v2)</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
  :root{
    --navy:#12213b;
    --traton-teal:#00838f;
    --traton-blue:#1565c0;
    --bg:#f6f8fb;
    --muted:#6b7280;
  }
  body{font-family:Inter,Segoe UI,Arial; background:var(--bg); margin:0; color:#222;}
  header{background:white; padding:18px 28px; box-shadow:0 2px 6px rgba(0,0,0,.06); display:flex; align-items:center; gap:20px;}
  header img.logo{height:36px}
  header h1{margin:0; font-size:20px; color:var(--navy)}
  main{padding:20px; max-width:1200px; margin:18px auto;}
  .top{display:flex; gap:20px; align-items:flex-start;}
  .circle-card{background:white; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.04); flex:0 0 520px; display:flex; flex-direction:column; align-items:center;}
  canvas#circleCanvas{border-radius:6px; background:white;}
  .controls{flex:1; background:white; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.04);}
  .controls h2{margin-top:0; color:var(--navy)}
  .form-row{display:flex; gap:8px; align-items:center; margin-bottom:8px;}
  label{font-size:13px; color:var(--muted); width:120px}
  select,input[type="text"]{padding:8px; border-radius:6px; border:1px solid #d1d5db; flex:1}
  button{background:var(--traton-teal); color:white; border:0; padding:9px 12px; border-radius:6px; cursor:pointer}
  .small{font-size:13px; color:var(--muted)}
  .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px}
  .box{background:white; padding:10px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,.04)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:6px 8px; border-bottom:1px solid #eef1f6}
  th{background:#fbfdff; text-align:left; font-weight:600; color:var(--navy)}
  .status-dot{display:inline-block; width:14px; height:14px; border-radius:50%; margin-right:6px; vertical-align:middle}
  .blue{background:#0b3b66} .green{background:#0f9d58} .yellow{background:#f0ad4e} .red{background:#d64545}
  .legend{display:flex; gap:10px; align-items:center; margin-top:10px}
  .footer{margin-top:18px; display:flex; gap:12px; align-items:center; justify-content:space-between}
  .import-area{display:flex; gap:10px; align-items:center}
  .note{font-size:12px; color:var(--muted)}
  .team-table{max-height:320px; overflow:auto}
  .counters{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}
  .counter{background:#f7fbfc; padding:6px 8px; border-radius:6px; font-size:13px; color:var(--navy)}
</style>
</head>
<body>
<header>
  <img class="logo" src="https://tratongroup.sharepoint.com/:i:/r/sites/GIO-Modularization/MODULARIZATIONA0006/03_Improvement%20work/Workbalance_Traton/Traton_logo.png" alt="TRATON">
  <div>
    <h1>Workbalance — TRATON</h1>
    <div class="small">Weekly team status & export (members × weeks). Exports include circle snapshot + area explanations.</div>
  </div>
</header>

<main>
  <div class="top">
    <div class="circle-card">
      <canvas id="circleCanvas" width="520" height="520"></canvas>
      <div class="legend" style="margin-top:8px">
        <div><span class="status-dot blue"></span>Very good (blue)</div>
        <div><span class="status-dot green"></span>Good (green)</div>
        <div><span class="status-dot yellow"></span>Watch (yellow)</div>
        <div><span class="status-dot red"></span>Critical (red)</div>
      </div>
      <div class="counters" id="areaCounts"></div>
    </div>

    <div class="controls">
      <h2>Status & File controls</h2>

      <div class="form-row">
        <label>Current week (YYWW)</label>
        <input id="weekInput" placeholder="e.g. 2520 (YYWW)" />
      </div>

      <div class="form-row">
        <label>Export filename</label>
        <input id="exportFileName" placeholder="team_workbalance.xlsx" />
      </div>

      <div class="form-row">
        <label>Circle image</label>
        <input id="circleURL" type="text" value="https://tratongroup.sharepoint.com/:i:/r/sites/GIO-Modularization/MODULARIZATIONA0006/03_Improvement%20work/Workbalance_Traton/workbalance_circle.png" />
      </div>

      <div class="grid">
        <div class="box">
          <div class="small">Set area status (this updates counts & overlay)</div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-direction:column;">
            <div style="display:flex; gap:6px; align-items:center;">
              <label style="width:140px">Manageability</label>
              <select id="areaManage">
                <option value="">—</option>
                <option value="blue">Very good</option>
                <option value="green">Good</option>
                <option value="yellow">Watch</option>
                <option value="red">Critical</option>
              </select>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <label style="width:140px">Comprehensibility</label>
              <select id="areaCompreh">
                <option value="">—</option>
                <option value="blue">Very good</option>
                <option value="green">Good</option>
                <option value="yellow">Watch</option>
                <option value="red">Critical</option>
              </select>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <label style="width:140px">Meaningfulness</label>
              <select id="areaMeaning">
                <option value="">—</option>
                <option value="blue">Very good</option>
                <option value="green">Good</option>
                <option value="yellow">Watch</option>
                <option value="red">Critical</option>
              </select>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <label style="width:140px">Recovery</label>
              <select id="areaRecovery">
                <option value="">—</option>
                <option value="blue">Very good</option>
                <option value="green">Good</option>
                <option value="yellow">Watch</option>
                <option value="red">Critical</option>
              </select>
            </div>
            <div style="margin-top:8px">
              <button id="applyAreaStatuses">Apply area statuses (adds as one combined dot each)</button>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="small">Team members (rows = members × areas). Pick import or add manually.</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <input type="file" id="importFile" accept=".xlsx" />
            <button id="btnImport">Import Excel</button>
          </div>
          <div style="margin-top:8px;">
            <button id="btnAddMember">Add member</button>
            <span class="note">Members loaded from import will reflect last-week participants only.</span>
          </div>
          <div class="team-table" style="margin-top:10px;">
            <table id="membersTable">
              <thead>
                <tr><th>Member</th><th>Area</th><th>Current (YYWW)</th><th>Previous week</th><th>Notes</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>
          <div class="import-area">
            <button id="btnExport">Export Excel</button>
            <div class="note">Export will include snapshot and explanations sheet.</div>
          </div>
        </div>
        <div class="note">Make sure you selected a valid YYWW before export.</div>
      </div>

    </div>
  </div>

  <div style="margin-top:18px" class="box">
    <h3 style="margin:6px 0;color:var(--navy)">Area explanations</h3>
    <p class="small">Click the links to view guidance on what to do when the area is blue/green (keep) or yellow/red (action).</p>
    <ul>
      <li><a href="#" onclick="showInfo('Manageability')">Manageability</a></li>
      <li><a href="#" onclick="showInfo('Comprehensibility')">Comprehensibility</a></li>
      <li><a href="#" onclick="showInfo('Meaningfulness')">Meaningfulness</a></li>
      <li><a href="#" onclick="showInfo('Recovery')">Recovery</a></li>
    </ul>
    <div id="infoPanel" style="margin-top:8px;padding:10px;background:#fff;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.03)"></div>
  </div>

</main>

<script>
/*
  Workbalance v2 - single-file HTML
  - ExcelJS used for import/export
  - Canvas snapshot with overlay dots included in exported workbook as PNG
  - Import expects a sheet "WorkbalanceData" with Member/Area/Week columns in the format we export (rows are Member, Area)
  - When importing, we auto-detect last week columns and include only members present in the latest week, then set currentWeek = increment(latestWeek)
*/

// Basic configuration
const AREAS = ["Manageability","Comprehensibility","Meaningfulness","Recovery"];
const COLORS = { blue:"#0b3b66", green:"#0f9d58", yellow:"#f0ad4e", red:"#d64545" };
let members = []; // array of {name, area, history: {YYWW: color}} -> but we'll store as flat rows: each member-area is a row
let currentWeek = "";
let circleImg = null;

// DOM hooks
const canvas = document.getElementById('circleCanvas');
const ctx = canvas.getContext('2d');
const areaCountsDiv = document.getElementById('areaCounts');
const membersTbody = document.querySelector('#membersTable tbody');
const weekInput = document.getElementById('weekInput');
const exportFileNameInput = document.getElementById('exportFileName');
const circleURLInput = document.getElementById('circleURL');

document.getElementById('btnAddMember').addEventListener('click', addMemberRow);
document.getElementById('btnImport').addEventListener('click', handleImportClick);
document.getElementById('btnExport').addEventListener('click', exportExcel);
document.getElementById('applyAreaStatuses').addEventListener('click', applyAreaStatuses);
document.getElementById('importFile').addEventListener('change', handleFileInput);

// initial
circleURLInput.addEventListener('change', loadCircleImage);
loadCircleImage(); // try load default
drawBaseCircle();

// helper functions
function drawBaseCircle(){
  // Draw background circle (we'll fetch the image and draw it when ready)
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // if image loaded draw scaled
  if(circleImg && circleImg.complete){
    // draw centered
    const cw = canvas.width, ch = canvas.height;
    const iw = circleImg.naturalWidth, ih = circleImg.naturalHeight;
    const scale = Math.min(cw/iw, ch/ih) * 0.98;
    const iw2 = iw*scale, ih2 = ih*scale;
    ctx.drawImage(circleImg, (cw-iw2)/2, (ch-ih2)/2, iw2, ih2);
  } else {
    // placeholder circle with quadrants
    const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-8;
    ctx.save();
    ctx.translate(cx,cy);
    // quadrants colors: keep original circle colors - we'll use image normally
    ctx.fillStyle = '#0f1b34';
    ctx.beginPath();
    ctx.arc(0,0,r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
  // overlay existing dots
  drawOverlayDots();
}

function loadCircleImage(){
  const url = circleURLInput.value.trim();
  if(!url) return;
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.onload = function(){ circleImg = img; drawBaseCircle(); }
  img.onerror = function(){ circleImg = null; drawBaseCircle(); }
  img.src = url;
}

// Data model helpers
function addMemberRow(name="New member", area=AREAS[0]){
  // create three rows per member? user wanted rows per member-area: we will create one row per area for that member
  const newName = prompt("Member name:", name);
  if(!newName) return;
  AREAS.forEach(a=>{
    members.push({ name: newName, area:a, history: {} });
  });
  renderMembersTable();
  updateCountsAndOverlay();
}

function renderMembersTable(){
  membersTbody.innerHTML='';
  members.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = r.name;
    const tdArea = document.createElement('td'); tdArea.textContent = r.area;
    const tdCur = document.createElement('td');
    // select for current week
    const sel = document.createElement('select');
    ['','blue','green','yellow','red'].forEach(v=>{
      const op = document.createElement('option');
      op.value=v; op.textContent = v?capitalize(v):"—";
      sel.appendChild(op);
    });
    if(currentWeek && r.history[currentWeek]) sel.value = r.history[currentWeek];
    sel.addEventListener('change', ()=>{ r.history[currentWeek]=sel.value; updateCountsAndOverlay(); });
    tdCur.appendChild(sel);

    const tdPrev = document.createElement('td'); tdPrev.className='small';
    tdPrev.textContent = getPrevWeekValue(r);

    const tdNotes = document.createElement('td');
    const inp = document.createElement('input'); inp.type='text'; inp.placeholder='notes'; inp.value=r.notes||'';
    inp.addEventListener('input', ()=>{ r.notes = inp.value; });
    tdNotes.appendChild(inp);

    const tdDel = document.createElement('td');
    const btn = document.createElement('button'); btn.textContent='Remove'; btn.style.background='#d64545';
    btn.addEventListener('click', ()=>{ members.splice(idx,1); renderMembersTable(); updateCountsAndOverlay(); });
    tdDel.appendChild(btn);

    tr.appendChild(tdName); tr.appendChild(tdArea); tr.appendChild(tdCur); tr.appendChild(tdPrev); tr.appendChild(tdNotes); tr.appendChild(tdDel);
    membersTbody.appendChild(tr);
  });
}

function getAllWeeksSorted(){
  const weeks = new Set();
  members.forEach(m=>{ Object.keys(m.history||{}).forEach(w=>weeks.add(w)); });
  return Array.from(weeks).sort();
}

function getPrevWeekValue(row){
  const weeks = getAllWeeksSorted();
  if(!weeks.length) return '';
  const last = weeks[weeks.length-1];
  return row.history[last] || '';
}

function updateCountsAndOverlay(){
  // areaCounts: for each area, counts per color
  const counts = {};
  AREAS.forEach(a=>counts[a] = {blue:0,green:0,yellow:0,red:0});
  members.forEach(m=>{
    if(currentWeek && m.history[currentWeek]){
      const c = m.history[currentWeek];
      if(counts[m.area] && c) counts[m.area][c]++;
    }
  });
  // render counters
  areaCountsDiv.innerHTML='';
  AREAS.forEach(a=>{
    const el = document.createElement('div'); el.className='counter';
    el.textContent = `${a}: `;
    const c = counts[a];
    el.innerHTML += ` <span style="color:${COLORS.blue}">● ${c.blue}</span> `;
    el.innerHTML += ` <span style="color:${COLORS.green}">● ${c.green}</span> `;
    el.innerHTML += ` <span style="color:${COLORS.yellow}">● ${c.yellow}</span> `;
    el.innerHTML += ` <span style="color:${COLORS.red}">● ${c.red}</span>`;
    areaCountsDiv.appendChild(el);
  });
  // draw overlay dots
  drawOverlayDots(counts);
}

function drawOverlayDots(counts){
  // Draw base
  drawBaseImageOnly();

  if(!counts) {
    // compute simple counts if not provided
    counts = {};
    AREAS.forEach(a=>counts[a] = {blue:0,green:0,yellow:0,red:0});
    members.forEach(m=>{
      if(currentWeek && m.history[currentWeek]) counts[m.area][m.history[currentWeek]]++;
    });
  }

  // For positioning, we place dots in 4 quadrants approx where the area labels are on the circle image.
  const cw = canvas.width, ch = canvas.height;
  const center = {x:cw/2, y:ch/2};
  const quadPositions = {
    Manageability: {x:center.x-120, y:center.y-120},
    Comprehensibility: {x:center.x+120, y:center.y-120},
    Meaningfulness: {x:center.x-120, y:center.y+120},
    Recovery: {x:center.x+120, y:center.y+120}
  };
  const spacing = 14;
  Object.keys(quadPositions).forEach(area=>{
    const p = quadPositions[area];
    const colCounts = counts[area];
    // draw rows per color with max 5 per row, create new row if >5
    let offsetY = 0;
    ['blue','green','yellow','red'].forEach(color=>{
      const n = colCounts[color] || 0;
      for(let i=0;i<n;i++){
        const row = Math.floor(i/5);
        const col = i%5;
        const x = p.x + col*(spacing+4);
        const y = p.y + offsetY + row*(spacing+4);
        ctx.beginPath();
        ctx.fillStyle = COLORS[color];
        ctx.arc(x,y,6,0,Math.PI*2);
        ctx.fill();
      }
      offsetY += 22; // next color row down
    });
  });
}

function drawBaseImageOnly(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(circleImg && circleImg.complete){
    const cw = canvas.width, ch = canvas.height;
    const iw = circleImg.naturalWidth, ih = circleImg.naturalHeight;
    const scale = Math.min(cw/iw, ch/ih) * 0.98;
    const iw2 = iw*scale, ih2 = ih*scale;
    ctx.drawImage(circleImg, (cw-iw2)/2, (ch-ih2)/2, iw2, ih2);
  } else {
    // fallback placeholder
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#12213b';
    ctx.beginPath();
    ctx.arc(canvas.width/2,canvas.height/2,220,0,Math.PI*2);
    ctx.fill();
  }
}

// apply area statuses (adds 1 combined dot for each area as "team-level" and increments no persons)
function applyAreaStatuses(){
  if(!currentWeek){ alert('Please fill current week (YYWW) first.'); return; }
  // apply as synthetic rows for "Team" if none exists
  const teamName = "(Team overall)";
  AREAS.forEach(area=>{
    // find the team row for this area, create if not exists
    let row = members.find(m=>m.name===teamName && m.area===area);
    if(!row){ row = {name:teamName, area:area, history:{}}; members.push(row); }
    const selId = areaToSelectId(area);
    const val = document.getElementById(selId).value;
    if(val) row.history[currentWeek] = val;
  });
  renderMembersTable();
  updateCountsAndOverlay();
}

function areaToSelectId(area){
  if(area==='Manageability') return 'areaManage';
  if(area==='Comprehensibility') return 'areaCompreh';
  if(area==='Meaningfulness') return 'areaMeaning';
  if(area==='Recovery') return 'areaRecovery';
  return '';
}

function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

// Import & export
async function handleImportClick(){
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files.length){ alert('Please pick a .xlsx file to import (download from SharePoint and choose it).'); return; }
  const file = fileInput.files[0];
  await importFromFile(file);
}

async function handleFileInput(e){
  // nothing; separate button will trigger
}

async function importFromFile(file){
  // read file with ExcelJS
  const buf = await file.arrayBuffer();
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(buf);
  // we expect a sheet named WorkbalanceData or first sheet
  let ws = wb.getWorksheet('WorkbalanceData') || wb.worksheets[0];
  if(!ws){ alert('Could not find a worksheet.'); return; }

  // find header row and weeks columns
  // header expected: ["Member","Area","YYWW1","YYWW2",...]
  const headerRow = ws.getRow(1).values.slice(1); // ExcelJS index starts at 1
  // headerRow now array: ["Member","Area","2520","2521"...]
  if(!headerRow || headerRow.length<2){ alert('Imported sheet has unexpected format. Need header row with Member, Area and week columns.'); return; }

  const weekCols = headerRow.slice(2).filter(Boolean);
  if(weekCols.length===0){ alert('No week columns found in imported sheet.'); return; }
  // detect latest week and increment
  const lastWeek = weekCols[weekCols.length-1].toString();
  const nextWeek = incrementYYWW(lastWeek);
  currentWeek = nextWeek;
  weekInput.value = currentWeek;

  // read rows, but only include members present in lastWeek (non-empty)
  const newMembers = [];
  ws.eachRow((row, rnum)=>{
    if(rnum===1) return;
    const vals = row.values.slice(1);
    const member = vals[0];
    const area = vals[1];
    if(!member || !area) return;
    // find value for lastWeek column index
    const lastWeekColIndex = 3 + (weekCols.length-1); // Excel columns start at 1; Member=1 Area=2; weeks start at 3
    const lastVal = row.getCell(lastWeekColIndex).value;
    if(lastVal && typeof lastVal === 'string' || typeof lastVal === 'number'){
      // include this member-area; we'll create with empty history for currentWeek
      const hist = {};
      // copy previous week values from sheet into history
      for(let i=0;i<weekCols.length;i++){
        const colIndex = 3 + i;
        const w = weekCols[i].toString();
        const v = row.getCell(colIndex).value;
        if(v && typeof v === 'string') hist[w] = v;
      }
      // reset currentWeek value -> leave empty so user must fill
      // we will set history but not set currentWeek
      newMembers.push({name: member.toString(), area: area.toString(), history: hist});
    }
  });

  // replace members but only those that were present previous week
  members = newMembers;
  renderMembersTable();
  updateCountsAndOverlay();
  alert(`Imported ${members.length} rows (member × area) from sheet. Current week set to ${currentWeek}. Current-week statuses are empty - please fill before export.`);
}

function incrementYYWW(yyww){
  // yyww is string like 2520 (year=25 week=20)
  const s = yyww.toString().trim();
  if(s.length!==4) {
    // fallback to current date's week
    const d = new Date();
    const isoWeek = getISOWeek(d);
    const yy = (d.getFullYear()%100).toString().padStart(2,'0');
    return yy + String(isoWeek).padStart(2,'0');
  }
  let yy = parseInt(s.slice(0,2),10);
  let ww = parseInt(s.slice(2),10);
  // naive increment
  ww++;
  // if >53 roll to next year
  if(ww>53){ ww=1; yy = (yy+1)%100; }
  return String(yy).padStart(2,'0') + String(ww).padStart(2,'0');
}
function getISOWeek(d) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  return Math.ceil((((date - yearStart) / 86400000) + 1)/7);
}

// Export Excel (ExcelJS)
async function exportExcel(){
  if(!weekInput.value || !/^\d{4}$/.test(weekInput.value)){ alert('Please enter a valid week in YYWW format (e.g. 2520).'); return; }
  currentWeek = weekInput.value.trim();
  // build workbook
  const wb = new ExcelJS.Workbook();
  wb.creator = 'Workbalance tool';
  wb.created = new Date();

  // 1) WorkbalanceData sheet - rows: Member, Area, week columns
  const allWeeks = getAllWeeksSorted();
  // ensure currentWeek included
  if(!allWeeks.includes(currentWeek)) allWeeks.push(currentWeek);
  allWeeks.sort();

  const ws = wb.addWorksheet('WorkbalanceData');
  // header
  const header = ['Member','Area', ...allWeeks];
  ws.addRow(header);
  // for each member-area row
  members.forEach(m=>{
    const row = [];
    row.push(m.name);
    row.push(m.area);
    allWeeks.forEach(w=>{
      const v = (m.history && m.history[w]) ? m.history[w] : '';
      row.push(v);
    });
    ws.addRow(row);
  });

  // 2) Explanations sheet
  const exp = wb.addWorksheet('Explanations');
  exp.addRow(['Workbalance overview']);
  exp.addRow([]);
  exp.addRow(['Areas and guidance:']);
  exp.addRow(['Manageability: Balance of resources & demands. Action for yellow/red: re-prioritize and re-allocate resources.']);
  exp.addRow(['Comprehensibility: Coherence and role clarity. Action for yellow/red: clarify roles and improve communication.']);
  exp.addRow(['Meaningfulness: Appreciation and involvement. Action for yellow/red: engage team and increase recognition.']);
  exp.addRow(['Recovery: Energy and ability to disconnect. Action for yellow/red: improve rest policies & workload.']);
  exp.addRow([]);
  exp.addRow(['Legend: blue=very good, green=good, yellow=watch, red=critical']);
  exp.addRow([]);

  // 3) Snapshot sheet with circle image + overlay
  // create an image from canvas
  const dataUrl = canvas.toDataURL('image/png');
  // add it to workbook
  const imageId = wb.addImage({ base64: dataUrl, extension: 'png' });
  const imgSheet = wb.addWorksheet('Circle_snapshot');
  // place image at top left and scale
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addRow([]);
  imgSheet.addImage(imageId, {
    tl: { col: 0.2, row: 0.5 },
    ext: { width: 720, height: 720 }
  });
  // add explanations on the right
  imgSheet.getCell('H2').value = 'Workbalance areas explanation';
  imgSheet.getCell('H3').value = 'Manageability: Balance of resources & demands';
  imgSheet.getCell('H4').value = 'Comprehensibility: Coherence and role clarity';
  imgSheet.getCell('H5').value = 'Meaningfulness: Appreciation & involvement';
  imgSheet.getCell('H6').value = 'Recovery: Rest, energy & reflection';
  imgSheet.getCell('H8').value = 'Colors:';
  imgSheet.getCell('H9').value = 'Blue = Very good';
  imgSheet.getCell('H10').value = 'Green = Good';
  imgSheet.getCell('H11').value = 'Yellow = Watch - action';
  imgSheet.getCell('H12').value = 'Red = Critical - immediate action';

  // finalize workbook and save
  const fileName = getExportFileName();
  const buf = await wb.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: "application/octet-stream" });
  saveAs(blob, fileName);
  alert('Exported ' + fileName);
}

function getExportFileName(){
  const custom = exportFileNameInput.value.trim();
  if(custom){
    return custom.endsWith('.xlsx') ? custom : (custom + '.xlsx');
  } else {
    // fallback: team_workbalance.xlsx
    const ts = new Date().toISOString().slice(0,10);
    return `team_workbalance_${ts}.xlsx`;
  }
}

// show info panel
function showInfo(area){
  let txt = '';
  if(area==='Manageability') txt = '<b>Manageability</b>: Balance of resources & demands. If yellow/red: consider re-prioritization, allocate resources, discuss with manager.';
  if(area==='Comprehensibility') txt = '<b>Comprehensibility</b>: Role clarity & security. If yellow/red: clarify roles, give clear feedback.';
  if(area==='Meaningfulness') txt = '<b>Meaningfulness</b>: Justice, appreciation and involvement. If yellow/red: talk to team, make improvements in recognition and development.';
  if(area==='Recovery') txt = '<b>Recovery</b>: Energy and ability to disconnect. If yellow/red: ensure rest, adjust workload and encourage reflection.';
  document.getElementById('infoPanel').innerHTML = txt;
}

// When users change week input, re-render selects
weekInput.addEventListener('change', ()=>{
  currentWeek = weekInput.value && weekInput.value.trim();
  renderMembersTable();
  updateCountsAndOverlay();
});

// load default circle
function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], {type:mime});
}

function capitalizeFirst(s){ return s && s[0].toUpperCase()+s.slice(1); }

</script>
</body>
</html>
